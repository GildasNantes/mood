<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mood Map (minimal)</title>

<link rel="stylesheet" href="./maplibre-gl.css">

<style>
  html, body { margin:0; height:100%; font:16px system-ui; }
  #map { position:fixed; inset:0; }

  #panel{
    position: fixed;
    z-index: 10;
    left: 12px; top: 12px;
    width: 320px;
    background: rgba(255,255,255,0.96);
    border-radius: 16px;
    box-shadow: 0 14px 36px rgba(0,0,0,.25);
    padding: 16px;
  }

  h3 { margin:0 0 10px; font-size:18px; }
  .row { display:grid; gap:10px; margin:10px 0; }

  input, button{
    font:inherit;
    padding:12px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.15);
  }
  button{ background:#111; color:#fff; border:0; cursor:pointer; }
  button:disabled { opacity: .55; cursor: not-allowed; }

  .small{ font-size:13px; opacity:.75; }
  .msg{ white-space:pre-wrap; font-size:13px; margin-top:8px; }

  :root { --vh: 1vh; }
  #map { height: calc(var(--vh) * 100); }

  @media (max-width: 520px) {
    #panel { width: calc(100vw - 24px); }
    button, input { padding: 14px; font-size: 16px; }
  }
</style>
</head>

<body>
<div id="map"></div>

<div id="panel">
  <h3>Mood Map</h3>

  <div class="row">
    <label>Your mood: <b><span id="moodValue">5</span>/10</b></label>
    <input id="slider" type="range" min="0" max="10" value="5">
  </div>

  <div class="row">
    <button id="btnSave">Locate + Save</button>
  </div>

  <div class="small" id="hint">Choose your mood, then tap “Locate + Save”.</div>
  <div class="msg" id="msg"></div>
</div>

<script src="./maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* iOS viewport fix */
function setVh(){ document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`); }
window.addEventListener('resize', setVh);
setVh();

/* Map */
const map = new maplibregl.Map({
  container: "map",
  style: {
    version: 8,
    sources: {
      osm: {
        type: "raster",
        tiles: [
          "https://a.tile.openstreetmap.org/{z}/{x}/{y}.png",
          "https://b.tile.openstreetmap.org/{z}/{x}/{y}.png",
          "https://c.tile.openstreetmap.org/{z}/{x}/{y}.png"
        ],
        tileSize: 256,
        attribution: "© OpenStreetMap contributors"
      }
    },
    layers: [{ id: "osm", type: "raster", source: "osm" }]
  },
  center: [0, 20],
  zoom: 2
});
map.addControl(new maplibregl.NavigationControl(), "top-right");

/* Supabase */
const SUPABASE_URL = "https://ugrmxzdhevqrgftlxfnp.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVncm14emRoZXZxcmdmdGx4Zm5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyODQ3OTQsImV4cCI6MjA4NDg2MDc5NH0.WgTj-6ADFEMrCgPNxeQZvknBBJI1c9uDY9_8Qlkqu4w";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Helpers */
const el = id => document.getElementById(id);
const slider = el("slider");
const moodValue = el("moodValue");
const msg = el("msg");
const btnSave = el("btnSave");

slider.oninput = () => moodValue.textContent = slider.value;

function setMsg(t){ msg.textContent = t || ""; }

function getAnonId(){
  const key = "mood_anon_id";
  let v = localStorage.getItem(key);
  if(!v){
    v = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "-" + Math.random());
    localStorage.setItem(key, v);
  }
  return v;
}

/* Save */
btnSave.onclick = async () => {
  setMsg("Locating…");

  if (!navigator.geolocation) {
    setMsg("Geolocation is not supported on this device.");
    return;
  }

  btnSave.disabled = true;

  navigator.geolocation.getCurrentPosition(async (pos) => {
    const anonId = getAnonId();
    const mood = parseInt(slider.value, 10);
    const lon = pos.coords.longitude;
    const lat = pos.coords.latitude;

    setMsg("Saving…");

    const row = { anon_id: anonId, mood, lon, lat };

    const { error } = await sb
      .from("mood_entries")
      .upsert(row, { onConflict: "anon_id" });

    if (error) {
      // show real error
      setMsg("Save failed: " + (error.message || "Unknown error"));
      console.warn("SAVE error:", error);
      btnSave.disabled = false;
      return;
    }

    setMsg("✅ Saved!");
    map.easeTo({ center: [lon, lat], zoom: Math.max(map.getZoom(), 8) });

    btnSave.disabled = false;

  }, (err) => {
    setMsg("Geolocation error: " + err.message);
    btnSave.disabled = false;
  }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
};
</script>
</body>
</html>
