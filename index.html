<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mood Map</title>

<link rel="stylesheet" href="./maplibre-gl.css">

<style>
  html, body { margin:0; height:100%; font:16px system-ui; }
  #map { position:fixed; inset:0; }

  #panel{
    position: fixed;
    z-index: 10;
    background: rgba(255,255,255,0.96);
    border-radius: 16px;
    box-shadow: 0 14px 36px rgba(0,0,0,.25);
    padding: 16px;
    transition: all .35s ease;
    padding-bottom: calc(16px + env(safe-area-inset-bottom));
    padding-top: calc(16px + env(safe-area-inset-top));
  }

  .panel-app{
    left:12px; top:12px;
    transform:none;
    width: 320px;
  }

  .panel-compact{
    left:12px; top:12px;
    transform:none;
    width: auto;
    padding: 10px 12px;
    border-radius: 14px;
  }

  h3 { margin:0 0 10px; font-size:18px; }
  .row { display:grid; gap:10px; margin:10px 0; }

  input, button, textarea{
    font:inherit;
    padding:12px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.15);
  }
  textarea{ resize: vertical; min-height: 120px; }
  button{ background:#111; color:#fff; border:0; cursor:pointer; }
  button.secondary{ background:#eee; color:#111; }
  button:disabled { opacity: .55; cursor: not-allowed; }

  .small{ font-size:13px; opacity:.75; }
  .msg{ white-space:pre-wrap; font-size:13px; }

  :root { --vh: 1vh; }
  #map { height: calc(var(--vh) * 100); }

  @media (max-width: 520px) {
    .panel-app{ width: calc(100vw - 24px); left: 12px; right: 12px; }
    .panel-compact{ left: 12px; right: 12px; }
    button, input, textarea { padding: 14px; font-size: 16px; }
  }

  /* ===========================
     FEEDBACK MODAL
     =========================== */
  #fbOverlay{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 60;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 12px;
  }
  #fbModal{
    width: min(720px, 100%);
    background: rgba(255,255,255,0.98);
    border-radius: 16px;
    box-shadow: 0 14px 36px rgba(0,0,0,.25);
    padding: 16px;
  }
  #fbModal h4 { margin: 0 0 10px; font-size: 17px; }
  #fbMeta{
    font-size: 13px;
    opacity: .85;
    background: rgba(0,0,0,0.04);
    padding: 10px 12px;
    border-radius: 12px;
    white-space: pre-wrap;
  }
  #fbCount{ font-size: 12px; opacity: .7; text-align:right; margin-top:6px; }
  .modal-actions { display:flex; gap:10px; justify-content:flex-end; }
</style>
</head>

<body>
<div id="map"></div>

<div id="panel" class="panel-app">
  <h3>Mood Map</h3>

  <!-- APP VIEW (NO LOGIN) -->
  <div id="appView">
    <div class="row">
      <label>Your mood: <b><span id="moodValue">5</span>/10</b></label>
      <input id="slider" type="range" min="0" max="10" value="5">
    </div>

    <div class="row">
      <button id="btnSaveAll">Locate + Save + Refresh</button>
    </div>

    <div class="small">
      1 save per day (per device). Markers appear after your first save.
    </div>
    <div id="appMsg" class="msg"></div>

    <div class="row" style="margin-top:8px;">
      <button id="btnFeedback" class="secondary" type="button">Any comments?</button>
    </div>
  </div>

  <!-- COMPACT VIEW -->
  <div id="compactView" style="display:none;">
    <div class="small" id="compactMsg">âœ… Saved.</div>

    <div class="row" style="margin-top:8px; gap:8px;">
      <button id="btnBack" class="secondary" type="button">Back</button>
      <button id="btnFeedback2" class="secondary" type="button">Any comments?</button>
    </div>
  </div>
</div>

<!-- FEEDBACK MODAL (stores into Supabase) -->
<div id="fbOverlay" aria-hidden="true">
  <div id="fbModal" role="dialog" aria-modal="true">
    <h4>Send a comment</h4>
    <div class="small">This message will be stored automatically.</div>
    <div style="height:10px"></div>

    <div id="fbMeta"></div>

    <div style="height:10px"></div>

    <label class="small" for="fbText">Message</label>
    <textarea id="fbText" maxlength="5000" placeholder="Write your comment here (max 5000 characters)â€¦"></textarea>
    <div id="fbCount">0 / 5000 â€¢ 0 / 250 words</div>

    <div id="fbMsg" class="msg" style="margin-top:8px;"></div>

    <div class="modal-actions" style="margin-top:12px;">
      <button id="btnFbCancel" class="secondary" type="button">Cancel</button>
      <button id="btnFbSend" type="button">Send</button>
    </div>
  </div>
</div>

<script src="./maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* =============================================================================
   0) MOBILE VIEWPORT FIX (iOS)
   ============================================================================= */
function setVh() {
  document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
}
window.addEventListener('resize', setVh);
setVh();

/* =============================================================================
   1) MAP SETUP
   ============================================================================= */
const map = new maplibregl.Map({
  container: "map",
  style: {
    version: 8,
    sources: {
      osm: {
        type: "raster",
        tiles: [
          "https://a.tile.openstreetmap.org/{z}/{x}/{y}.png",
          "https://b.tile.openstreetmap.org/{z}/{x}/{y}.png",
          "https://c.tile.openstreetmap.org/{z}/{x}/{y}.png"
        ],
        tileSize: 256,
        attribution: "Â© OpenStreetMap contributors"
      }
    },
    layers: [{ id: "osm", type: "raster", source: "osm" }]
  },
  center: [0, 20],
  zoom: 2
});
map.addControl(new maplibregl.NavigationControl(), "top-right");

/* =============================================================================
   2) MOOD ICONS (0..10)
   ============================================================================= */
function lerp(a,b,t){ return a + (b - a) * t; }
function lerpColor(c1,c2,t){
  const r = Math.round(lerp(c1[0], c2[0], t));
  const g = Math.round(lerp(c1[1], c2[1], t));
  const b = Math.round(lerp(c1[2], c2[2], t));
  return `rgb(${r},${g},${b})`;
}
function moodImageData(level, size=96){
  const t = Math.max(0, Math.min(1, level/10));
  const red=[215,25,28], yellow=[255,255,191], green=[26,150,65];
  const fill = (t < 0.5)
    ? lerpColor(red, yellow, t/0.5)
    : lerpColor(yellow, green, (t-0.5)/0.5);

  const canvas = document.createElement("canvas");
  canvas.width = size; canvas.height = size;
  const ctx = canvas.getContext("2d");

  const cx = size/2, cy = size/2, r = size*0.42;

  ctx.beginPath(); ctx.arc(cx, cy+3, r, 0, Math.PI*2);
  ctx.fillStyle="rgba(0,0,0,0.18)"; ctx.fill();

  ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2);
  ctx.fillStyle = fill; ctx.fill();
  ctx.lineWidth = Math.max(3, size*0.04);
  ctx.strokeStyle = "rgba(0,0,0,0.25)";
  ctx.stroke();

  const eyeY = cy - size*0.10, eyeDX=size*0.14, eyeR=size*0.04;
  ctx.beginPath();
  ctx.arc(cx-eyeDX, eyeY, eyeR, 0, Math.PI*2);
  ctx.arc(cx+eyeDX, eyeY, eyeR, 0, Math.PI*2);
  ctx.fillStyle="rgba(0,0,0,0.75)";
  ctx.fill();

  const browY = eyeY - size*0.08;
  const browTilt = lerp(0.20, -0.20, t);
  ctx.lineWidth = Math.max(3, size*0.035);
  ctx.strokeStyle="rgba(0,0,0,0.55)";
  ctx.lineCap="round";

  ctx.beginPath();
  ctx.moveTo(cx-eyeDX-size*0.06, browY + browTilt*size*0.08);
  ctx.lineTo(cx-eyeDX+size*0.06, browY - browTilt*size*0.08);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(cx+eyeDX-size*0.06, browY - browTilt*size*0.08);
  ctx.lineTo(cx+eyeDX+size*0.06, browY + browTilt*size*0.08);
  ctx.stroke();

  const mouthY = cy + size*0.12, mouthW=size*0.26;
  const curvature = lerp(-1, 1, t);
  ctx.beginPath();
  ctx.moveTo(cx-mouthW, mouthY);
  ctx.quadraticCurveTo(cx, mouthY + curvature*size*0.12, cx+mouthW, mouthY);
  ctx.strokeStyle="rgba(0,0,0,0.70)";
  ctx.lineWidth=Math.max(4, size*0.05);
  ctx.lineCap="round";
  ctx.stroke();

  const img = ctx.getImageData(0,0,size,size);
  return { width: img.width, height: img.height, data: img.data };
}
function ensureMoodImages(){
  for(let lvl=0; lvl<=10; lvl++){
    const name = `mood-${lvl}`;
    if(!map.hasImage(name)) map.addImage(name, moodImageData(lvl,96));
  }
}

/* =============================================================================
   3) POINTS SOURCE + LAYERS
   ============================================================================= */
function initPointsSourceAndLayers(){
  if(map.getSource("points")) return;

  map.addSource("points", {
    type: "geojson",
    data: { type:"FeatureCollection", features: [] },
    cluster: true,
    clusterRadius: 60,
    clusterMaxZoom: 14,
    clusterProperties: { sum: ["+", ["get", "value"]], count: ["+", 1] }
  });

  const avgRoundedClamped = [
    "case",
    ["<", ["round", ["/", ["get","sum"], ["get","count"]]], 0], 0,
    [">", ["round", ["/", ["get","sum"], ["get","count"]]], 10], 10,
    ["round", ["/", ["get","sum"], ["get","count"]]]
  ];

  map.addLayer({
    id: "clusters-mood",
    type: "symbol",
    source: "points",
    filter: ["has", "point_count"],
    layout: {
      "icon-image": ["concat","mood-", ["to-string", avgRoundedClamped]],
      "icon-size": ["step", ["get","point_count"], 0.65, 10, 0.75, 50, 0.9, 200, 1.05, 1000, 1.2],
      "icon-allow-overlap": true,
      "text-field": ["to-string", ["get","point_count"]],
      "text-size": 12,
      "text-offset": [0, 1.55],
      "text-allow-overlap": true,
      "text-anchor": "top"
    },
    paint: {
      "text-color": "rgba(0,0,0,0.75)",
      "text-halo-color": "rgba(255,255,255,0.9)",
      "text-halo-width": 1
    }
  });

  map.addLayer({
    id: "points-mood",
    type: "symbol",
    source: "points",
    filter: ["!", ["has", "point_count"]],
    layout: {
      "icon-image": [
        "concat","mood-",
        ["to-string",
          ["case",
            ["<", ["round", ["get","value"]], 0], 0,
            [">", ["round", ["get","value"]], 10], 10,
            ["round", ["get","value"]]
          ]
        ]
      ],
      "icon-size": 0.55,
      "icon-allow-overlap": true
    }
  });

  map.on("click", "clusters-mood", (e) => {
    const f = e.features[0];
    map.getSource("points").getClusterExpansionZoom(
      f.properties.cluster_id,
      (err, zoom) => {
        if (err) return;
        map.easeTo({ center: f.geometry.coordinates, zoom });
      }
    );
  });

  map.on("mouseenter", "clusters-mood", () => map.getCanvas().style.cursor = "pointer");
  map.on("mouseleave", "clusters-mood", () => map.getCanvas().style.cursor = "");
}

function clearMarkers(){
  const source = map.getSource("points");
  if(!source) return;
  source.setData({ type:"FeatureCollection", features: [] });
}

async function refreshPoints(){
  const source = map.getSource("points");
  if(!source) return;

  const { data, error } = await sb
    .from("mood_entries")
    .select("mood, lon, lat")
    .order("created_at", { ascending:false })
    .limit(20000);

  if(error){
    setAppMessage("Load error:\n" + error.message);
    return;
  }

  const features = (data || [])
    .filter(r => typeof r.lon==="number" && typeof r.lat==="number")
    .map(r => ({
      type: "Feature",
      properties: { value: r.mood },
      geometry: { type:"Point", coordinates:[r.lon, r.lat] }
    }));

  source.setData({ type:"FeatureCollection", features });
  setAppMessage(`Loaded markers: ${features.length}`);
}

/* =============================================================================
   4) UI HELPERS
   ============================================================================= */
const el = id => document.getElementById(id);
const panel = el("panel");

function setAppMessage(msg){ el("appMsg").textContent = msg || ""; }

function showApp(){
  panel.className = "panel-app";
  el("appView").style.display = "block";
  el("compactView").style.display = "none";
}
function showCompact(msg="âœ… Saved."){
  panel.className = "panel-compact";
  el("compactMsg").textContent = msg;
  el("appView").style.display = "none";
  el("compactView").style.display = "block";
}

const slider = el("slider");
slider.oninput = ()=> el("moodValue").textContent = slider.value;

/* =============================================================================
   5) SUPABASE CONFIG
   ============================================================================= */
const SUPABASE_URL = "https://ugrmxzdhevqrgftlxfnp.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVncm14emRoZXZxcmdmdGx4Zm5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyODQ3OTQsImV4cCI6MjA4NDg2MDc5NH0.WgTj-6ADFEMrCgPNxeQZvknBBJI1c9uDY9_8Qlkqu4w";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =============================================================================
   6) ANON ID (local)
   ============================================================================= */
function getAnonId(){
  const key = "mood_anon_id";
  let v = localStorage.getItem(key);
  if(!v){
    v = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "-" + Math.random());
    localStorage.setItem(key, v);
  }
  return v;
}

/* =============================================================================
   7) SAVE (insert-only, 1/day via unique index on (anon_id, day))
   ============================================================================= */
let lastFix = null;

el("btnSaveAll").onclick = async () => {
  setAppMessage("Locatingâ€¦");

  const anonId = getAnonId();

  if (!navigator.geolocation) {
    setAppMessage("Geolocation not supported.");
    return;
  }

  navigator.geolocation.getCurrentPosition(async (pos) => {
    const coords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
    const mood = parseInt(slider.value, 10);

    lastFix = { lat: coords.lat, lon: coords.lon, accuracy: pos.coords.accuracy };

    setAppMessage("Savingâ€¦");

    const row = {
      anon_id: anonId,
      mood,
      lon: coords.lon,
      lat: coords.lat,
      location: `POINT(${coords.lon} ${coords.lat})`
    };

    const { error } = await sb.from("mood_entries").insert(row);

    if (error) {
      const raw = (error.message || "") + " " + (error.details || "") + " " + (error.hint || "");
      const isDup = raw.includes("mood_entries_one_per_day") || raw.includes("duplicate key value");
      if (isDup) {
        setAppMessage("âœ… Already saved today ðŸ™‚ Come back tomorrow.");
        showCompact("âœ… Already saved today ðŸ™‚");
      } else {
        setAppMessage("Save error:\n" + error.message);
      }
      return;
    }

    map.easeTo({ center: [coords.lon, coords.lat], zoom: Math.max(map.getZoom(), 8) });
    setAppMessage("âœ… Saved. Loading markersâ€¦");
    await refreshPoints();

    showCompact("âœ… Saved. Thank you!");
  }, (err) => {
    setAppMessage("Geolocation error: " + err.message);
  }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
};

el("btnBack").onclick = () => {
  showApp();
  setAppMessage("");
};

/* =============================================================================
   8) FEEDBACK (anonymous)
   ============================================================================= */
const FEEDBACK_MAX_WORDS = 250;
function countWords(s) { return (s.trim().match(/\S+/g) || []).length; }

const fbOverlay = el("fbOverlay");
const fbText = el("fbText");
const fbMeta = el("fbMeta");
const fbMsg  = el("fbMsg");
const fbCount = el("fbCount");
const btnFbSend = el("btnFbSend");

function updateFbCounter(){
  const chars = fbText.value.length;
  const words = countWords(fbText.value);
  fbCount.textContent = `${chars} / 5000 â€¢ ${words} / ${FEEDBACK_MAX_WORDS} words`;
}
function openFeedbackModal(metaText){
  fbMsg.textContent = "";
  fbText.value = "";
  fbMeta.textContent = metaText || "";
  fbOverlay.style.display = "flex";
  fbOverlay.setAttribute("aria-hidden", "false");
  updateFbCounter();
  setTimeout(() => fbText.focus(), 50);
}
function closeFeedbackModal(){
  fbOverlay.style.display = "none";
  fbOverlay.setAttribute("aria-hidden", "true");
}
fbOverlay.addEventListener("click", (e) => { if (e.target === fbOverlay) closeFeedbackModal(); });
el("btnFbCancel").onclick = closeFeedbackModal;
fbText.addEventListener("input", updateFbCounter);

function feedbackMetaText(){
  const anonId = getAnonId();
  const lf = lastFix;
  const locLine = lf
    ? `Last location: ${lf.lat.toFixed(6)}, ${lf.lon.toFixed(6)} (Â±${Math.round(lf.accuracy)}m)`
    : `Last location: unknown (tap "Locate + Save + Refresh" first)`;
  return `Anon: ${anonId}\n${locLine}\nUA: ${navigator.userAgent}`;
}

el("btnFeedback").onclick = () => openFeedbackModal(feedbackMetaText());
el("btnFeedback2").onclick = () => openFeedbackModal(feedbackMetaText());

let fbBusy = false;
btnFbSend.onclick = async () => {
  if (fbBusy) return;
  fbBusy = true;
  btnFbSend.disabled = true;
  fbMsg.textContent = "Savingâ€¦";

  const message = fbText.value.trim();
  if (message.length < 2) {
    fbMsg.textContent = "Please write a message.";
    btnFbSend.disabled = false;
    fbBusy = false;
    return;
  }

  const words = countWords(message);
  if (words > FEEDBACK_MAX_WORDS) {
    fbMsg.textContent = `Too many words (${words}). Max is ${FEEDBACK_MAX_WORDS}.`;
    btnFbSend.disabled = false;
    fbBusy = false;
    return;
  }

  const anonId = getAnonId();
  const lf = lastFix || {};

  // NOTE: this assumes your mood_feedback table can accept anon_id (text) and NULL user_id.
  // If your table requires user_id (uuid NOT NULL), tell me and Iâ€™ll adapt the SQL.
  const row = {
    anon_id: anonId,
    message,
    lat: (typeof lf.lat === "number") ? lf.lat : null,
    lon: (typeof lf.lon === "number") ? lf.lon : null,
    accuracy_m: (typeof lf.accuracy === "number") ? Math.round(lf.accuracy) : null,
    user_agent: navigator.userAgent
  };

  const { error } = await sb.from("mood_feedback").insert(row);

  if (error) {
    const raw = (error.message || "") + " " + (error.details || "") + " " + (error.hint || "");
    const isDuplicate =
      error.code === "23505" ||
      raw.includes("duplicate key value") ||
      raw.includes("mood_feedback_one_per_day");

    if (isDuplicate) {
      fbMsg.textContent =
        "You have already sent a comment today.\n\n" +
        "Only one comment per day is allowed.\n" +
        "Please come back tomorrow ðŸ™‚";
    } else {
      fbMsg.textContent = "An unexpected error occurred.\n\n" + (error.message || "Unknown error");
    }

    btnFbSend.disabled = false;
    fbBusy = false;
    return;
  }

  fbMsg.textContent = "âœ… Saved. Thank you!";
  setTimeout(() => closeFeedbackModal(), 650);

  btnFbSend.disabled = false;
  fbBusy = false;
};

/* =============================================================================
   9) MAP INIT
   ============================================================================= */
map.on("load", async () => {
  ensureMoodImages();
  initPointsSourceAndLayers();
  clearMarkers();

  // Start directly in the app
  showApp();
  setAppMessage("Choose your mood ðŸ™‚");

  // Optional: preload markers immediately
  await refreshPoints();
});
</script>
</body>
</html>
