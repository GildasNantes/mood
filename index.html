<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mood Map</title>

<link rel="stylesheet" href="./maplibre-gl.css">

<style>
html,body{margin:0;height:100%;font:16px system-ui;}
#map{position:fixed;inset:0}
#panel{
  position:fixed;left:12px;top:12px;width:320px;
  background:rgba(255,255,255,.96);
  border-radius:16px;box-shadow:0 14px 36px rgba(0,0,0,.25);
  padding:16px;z-index:10;
}
.row{margin:10px 0;display:grid;gap:10px}
button,input,textarea{
  font:inherit;padding:12px;border-radius:12px;border:1px solid rgba(0,0,0,.15)
}
button{background:#111;color:#fff;border:0;cursor:pointer}
button.secondary{background:#eee;color:#111}
button:disabled{opacity:.5}
.small{font-size:13px;opacity:.75}
.msg{font-size:13px;white-space:pre-wrap}
#fbOverlay{
  position:fixed;inset:0;background:rgba(0,0,0,.45);
  display:none;align-items:center;justify-content:center;z-index:20
}
#fbModal{
  width:min(520px,90vw);
  background:#fff;border-radius:16px;padding:16px
}
</style>
</head>

<body>
<div id="map"></div>

<div id="panel">
  <h3>Mood Map</h3>

  <div class="row">
    <label>Your mood: <b><span id="moodValue">5</span>/10</b></label>
    <input id="slider" type="range" min="0" max="10" value="5">
  </div>

  <div class="row">
    <button id="btnSave">Locate + Save</button>
  </div>

  <div class="small">
    Choose your mood, then tap ‚ÄúLocate + Save‚Äù to reveal the world‚Äôs mood üåç
  </div>

  <div id="msg" class="msg"></div>

  <div class="row">
    <button id="btnFeedback" class="secondary" disabled>Any comments?</button>
  </div>
</div>

<!-- FEEDBACK MODAL -->
<div id="fbOverlay">
  <div id="fbModal">
    <h4>Send a comment</h4>
    <textarea id="fbText" placeholder="Write your comment here‚Ä¶" maxlength="5000"></textarea>
    <div class="row">
      <button id="fbCancel" class="secondary">Cancel</button>
      <button id="fbSend">Send</button>
    </div>
    <div id="fbMsg" class="msg"></div>
  </div>
</div>

<script src="./maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = "https://ugrmxzdhevqrgftlxfnp.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_ANON_KEY_HERE";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const el=id=>document.getElementById(id);
const slider=el("slider"), moodValue=el("moodValue");
slider.oninput=()=>moodValue.textContent=slider.value;

function anonId(){
  let v=localStorage.getItem("anon_id");
  if(!v){v=crypto.randomUUID();localStorage.setItem("anon_id",v);}
  return v;
}

let revealed=false;

el("btnSave").onclick=()=>{
  el("msg").textContent="Locating‚Ä¶";
  navigator.geolocation.getCurrentPosition(async pos=>{
    const row={
      anon_id:anonId(),
      mood:+slider.value,
      lon:pos.coords.longitude,
      lat:pos.coords.latitude
    };

    el("msg").textContent="Saving‚Ä¶";

    const {error}=await sb
      .from("mood_entries")
      .upsert(row,{onConflict:"anon_id"});

    if(error){
      el("msg").textContent="Save failed. Please try again later.";
      console.warn(error);
      return;
    }

    revealed=true;
    el("msg").textContent="Thank you! The world‚Äôs mood is now visible üåç";
    el("btnFeedback").disabled=false;
  });
};

// Feedback
el("btnFeedback").onclick=()=>{
  el("fbOverlay").style.display="flex";
  el("fbMsg").textContent="";
  el("fbText").value="";
};

el("fbCancel").onclick=()=>el("fbOverlay").style.display="none";

el("fbSend").onclick=async()=>{
  const message=el("fbText").value.trim();
  if(message.length<2){
    el("fbMsg").textContent="Please write a message.";
    return;
  }

  const {error}=await sb.from("mood_feedback").insert({
    anon_id:anonId(),
    message
  });

  if(error){
    el("fbMsg").textContent="Unable to send comment.";
    console.warn(error);
    return;
  }

  el("fbMsg").textContent="Thank you for your feedback!";
  setTimeout(()=>el("fbOverlay").style.display="none",800);
};
</script>
</body>
</html>
