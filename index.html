<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mood2Know</title>

<link rel="stylesheet" href="./maplibre-gl.css">

<style>
html,body{margin:0;height:100%;font:16px system-ui}
#map{position:fixed;inset:0}

/* PANEL */
#panel{
  position:fixed;left:12px;top:12px;z-index:10;
  background:rgba(255,255,255,.96);
  border-radius:16px;
  box-shadow:0 14px 36px rgba(0,0,0,.25);
  padding:16px;
  transition:.35s ease;
}
.panel-app{width:320px}
.panel-compact{padding:10px 12px}
.panel-mini{padding:8px;border-radius:999px}

#dragHandle{
  width:54px;height:6px;margin:6px auto 10px;
  background:rgba(0,0,0,.18);
  border-radius:999px;
  cursor:grab;
  touch-action:none;
}

h3{margin:0 0 6px}
.row{display:grid;gap:10px;margin:10px 0}
.small{font-size:13px;opacity:.75}
.msg{white-space:pre-wrap;font-size:13px}

button,input,textarea{
  font:inherit;padding:12px;border-radius:12px;
  border:1px solid rgba(0,0,0,.15)
}
button{background:#111;color:#fff;border:0}
button.secondary{background:#eee;color:#111}
button:disabled{opacity:.55}

#appView,#compactView,#miniView{display:none}
.pill{padding:10px 14px;border-radius:999px;font-weight:600}

#fbOverlay{
  position:fixed;inset:0;display:none;
  background:rgba(0,0,0,.45);z-index:60;
  align-items:center;justify-content:center
}
#fbModal{
  background:#fff;border-radius:16px;
  padding:16px;width:min(720px,100%)
}
</style>
</head>

<body>
<div id="map"></div>

<div id="panel" class="panel-app">
  <h3>Mood2Know</h3>
  <div id="dragHandle"></div>

  <div id="appView">
    <label>Your mood: <b><span id="moodValue">5</span>/10</b></label>
    <input id="slider" type="range" min="0" max="10" value="5">
    <button id="btnSave">Locate + Save</button>
    <div class="small">Choose your mood to reveal the world üåç</div>
    <div id="appMsg" class="msg"></div>
  </div>

  <div id="compactView">
    <div class="small" id="compactMsg">Saved.</div>
    <button id="btnFeedback" class="secondary">Any comments?</button>
    <button id="btnMini" class="secondary">Minimize</button>
    <button id="btnExpand" class="secondary">Change mood</button>
  </div>

  <div id="miniView">
    <button id="btnMiniOpen" class="pill">Any comments?</button>
  </div>
</div>

<!-- FEEDBACK -->
<div id="fbOverlay">
  <div id="fbModal">
    <h4>Send a comment</h4>
    <textarea id="fbText" maxlength="5000"></textarea>
    <div id="fbMsg" class="msg"></div>
    <button id="btnFbSend">Send</button>
    <button id="btnFbCancel" class="secondary">Cancel</button>
  </div>
</div>

<script src="./maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ===== INIT MAP ===== */
const map=new maplibregl.Map({
  container:"map",
  style:{version:8,sources:{osm:{type:"raster",tiles:[
    "https://a.tile.openstreetmap.org/{z}/{x}/{y}.png"
  ],tileSize:256}},layers:[{id:"osm",type:"raster",source:"osm"}]},
  center:[0,20],zoom:2
});
map.addControl(new maplibregl.NavigationControl());

/* ===== UI ===== */
const el=id=>document.getElementById(id);
el("slider").oninput=()=>el("moodValue").textContent=el("slider").value;
function showApp(){panel.className="panel-app";appView.style.display="block";compactView.style.display=miniView.style.display="none"}
function showCompact(m){panel.className="panel-compact";compactMsg.textContent=m;appView.style.display=miniView.style.display="none";compactView.style.display="block"}
function showMini(){panel.className="panel-mini";appView.style.display=compactView.style.display="none";miniView.style.display="block"}

/* ===== DRAG ===== */
let drag=false,ox,oy;
dragHandle.onpointerdown=e=>{drag=true;ox=e.clientX-panel.offsetLeft;oy=e.clientY-panel.offsetTop}
document.onpointermove=e=>{if(drag){panel.style.left=e.clientX-ox+"px";panel.style.top=e.clientY-oy+"px"}}
document.onpointerup=()=>drag=false;

/* ===== SUPABASE ===== */
const sb=supabase.createClient(
 "https://ugrmxzdhevqrgftlxfnp.supabase.co",
 "PUBLIC_ANON_KEY_HERE"
);
const anon=localStorage.moodAnon||(
 localStorage.moodAnon=crypto.randomUUID()
);

/* ===== SAVE ===== */
btnSave.onclick=async()=>{
  appMsg.textContent="Locating‚Ä¶";
  navigator.geolocation.getCurrentPosition(async p=>{
    const {error}=await sb.from("mood_entries").upsert({
      anon_id:anon,
      mood:+slider.value,
      lat:p.coords.latitude,
      lon:p.coords.longitude
    },{onConflict:"anon_id"});
    if(error){appMsg.textContent="Only one save per minute please!";return}
    showCompact("Thank you!");
  });
};

/* ===== FEEDBACK ===== */
btnFeedback.onclick=()=>fbOverlay.style.display="flex";
btnFbCancel.onclick=()=>fbOverlay.style.display="none";
btnFbSend.onclick=async()=>{
  await sb.from("mood_feedback").insert({anon_id:anon,message:fbText.value});
  fbOverlay.style.display="none";
};

/* ===== MINI ===== */
btnMini.onclick=showMini;
btnExpand.onclick=showApp;
let last=0;
btnMiniOpen.onclick=()=>{if(Date.now()-last<300)showCompact("Saved");last=Date.now()}

showApp();
</script>
</body>
</html>

