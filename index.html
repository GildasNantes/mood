// V7 du 28 jan 2026

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mood Map</title>

<link rel="stylesheet" href="./maplibre-gl.css">

<style>
  html, body { margin:0; height:100%; font:16px system-ui; }
  #map { position:fixed; inset:0; }

  #panel{
    position: fixed;
    z-index: 10;
    background: rgba(255,255,255,0.96);
    border-radius: 16px;
    box-shadow: 0 14px 36px rgba(0,0,0,.25);
    padding: 16px;
    transition: all .35s ease;
  }

  .panel-welcome{
    left:50%; top:50%;
    transform:translate(-50%,-50%);
    width: min(440px, calc(100vw - 24px));
  }

  .panel-app{
    left:12px; top:12px;
    transform:none;
    width: 320px;
  }

  /* Ultra compact after first successful save (mobile-friendly) */
  .panel-compact{
    left:12px; top:12px;
    transform:none;
    width: auto;
    padding: 10px 12px;
    border-radius: 14px;
  }

  h3 { margin:0 0 10px; font-size:18px; }
  .row { display:grid; gap:10px; margin:10px 0; }

  input, button{
    font:inherit;
    padding:12px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.15);
  }
  button{ background:#111; color:#fff; border:0; cursor:pointer; }
  button.secondary{ background:#eee; color:#111; }
  button.link{
    background: transparent;
    color: #111;
    border: 0;
    padding: 0;
    text-align: left;
    text-decoration: underline;
    cursor: pointer;
    font-size: 14px;
    opacity: .85;
  }
  button:disabled { opacity: .55; cursor: not-allowed; }

  #welcomeBox{
    background: linear-gradient(135deg,#ffecd2,#fcb69f);
    border-radius:14px;
    padding:14px;
  }

  .small{ font-size:13px; opacity:.75; }
  .msg{ white-space:pre-wrap; font-size:13px; }

  #authView,#appView,#compactView,#resetView{ display:none; }

  /* Mobile tweaks */
  @media (max-width: 520px) {
    .panel-welcome{ width: calc(100vw - 24px); }
    .panel-app{ width: calc(100vw - 24px); left: 12px; right: 12px; }
    button, input { padding: 14px; font-size: 16px; } /* prevents iOS zoom on inputs */
    .panel-compact{ left: 12px; right: 12px; }
  }

  /* iPhone safe areas */
  #panel{
    padding-bottom: calc(16px + env(safe-area-inset-bottom));
    padding-top: calc(16px + env(safe-area-inset-top));
  }

  :root { --vh: 1vh; }
  #map { height: calc(var(--vh) * 100); }

  /* ===========================
     SIMPLE MODAL (for signup)
     =========================== */
  #overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 50;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 12px;
  }
  #modal {
    width: min(520px, 100%);
    background: rgba(255,255,255,0.98);
    border-radius: 16px;
    box-shadow: 0 14px 36px rgba(0,0,0,.25);
    padding: 16px;
  }
  #modal h4 { margin: 0 0 10px; font-size: 17px; }
  .modal-actions { display:flex; gap:10px; justify-content:flex-end; }
  .warn { color:#b00020; font-size: 13px; white-space: pre-wrap; }
</style>
</head>

<body>
<div id="map"></div>

<div id="panel" class="panel-welcome">
  <h3>Mood Map</h3>

  <!-- =========================
       AUTH VIEW (Login + Forgot)
       ========================= -->
  <div id="authView">
    <div id="welcomeBox">
      <b>Welcome üåç</b><br><br>
      Discover the mood of the world.<br>
      Create an account to share how you feel and explore
      how happy people are across different places.
    </div>

    <!-- LOGIN inputs -->
    <div class="row">
      <input id="email" type="email" placeholder="Email" autocomplete="email">
      <input id="password" type="password" placeholder="Password" autocomplete="current-password">
    </div>

    <div class="row" style="grid-template-columns:1fr 1fr">
      <button id="btnLogin">Sign in</button>
      <button id="btnOpenSignup" class="secondary">Create account</button>
    </div>

    <div class="row">
      <button id="btnForgot" class="link" type="button">Forgot your password?</button>
      <div class="small">We will email you a reset link.</div>
    </div>

    <div id="authMsg" class="msg"></div>
  </div>

  <!-- =========================
       RESET PASSWORD VIEW
       ========================= -->
  <div id="resetView">
    <div id="welcomeBox">
      <b>Reset your password</b><br><br>
      Please choose a new password (enter it twice).
    </div>

    <div class="row">
      <input id="newPassword1" type="password" placeholder="New password">
      <input id="newPassword2" type="password" placeholder="Confirm new password">
    </div>

    <div class="row">
      <button id="btnDoReset">Update password</button>
      <button id="btnResetCancel" class="secondary" type="button">Back</button>
    </div>

    <div id="resetMsg" class="msg"></div>
  </div>

  <!-- =========================
       APP VIEW (mood + save)
       ========================= -->
  <div id="appView">
    <div class="row">
      <label>Your mood: <b><span id="moodValue">5</span>/10</b></label>
      <input id="slider" type="range" min="0" max="10" value="5">
    </div>

    <div class="row">
      <button id="btnSaveAll">Locate + Save + Refresh</button>
    </div>

    <div class="small">Markers appear after your first save.</div>
    <div id="appMsg" class="msg"></div>

    <div class="row">
      <button id="btnLogout" class="secondary">Sign out</button>
    </div>
  </div>

  <!-- COMPACT panel (after save) -->
  <div id="compactView">
    <div class="small" id="compactMsg">‚úÖ Saved.</div>
    <div class="row" style="margin-top:8px;">
      <button id="btnLogout2" class="secondary">Sign out</button>
    </div>
  </div>
</div>

<!-- =========================
     SIGNUP MODAL
     ========================= -->
<div id="overlay" aria-hidden="true">
  <div id="modal" role="dialog" aria-modal="true">
    <h4>Create your account</h4>

    <div class="small">
      You should receive a confirmation email.
      Your account becomes active after you confirm.
      You may close this windows now.
      <br><br>
    </div>

    <div class="row">
      <input id="suEmail" type="email" placeholder="Email" autocomplete="email">
      <input id="suPass1" type="password" placeholder="Password (min 6 chars)" autocomplete="new-password">
      <input id="suPass2" type="password" placeholder="Confirm password" autocomplete="new-password">
    </div>

    <div id="suMsg" class="warn"></div>

    <div class="modal-actions">
      <button id="btnCloseSignup" class="secondary" type="button">Cancel</button>
      <button id="btnSignup" type="button">Create account</button>
    </div>
  </div>
</div>

<script src="./maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* =============================================================================
   0) MOBILE VIEWPORT FIX (iOS)
   ============================================================================= */
function setVh() {
  document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
}
window.addEventListener('resize', setVh);
setVh();

/* =============================================================================
   1) MAP SETUP (MapLibre + OSM raster tiles)
   ============================================================================= */
const map = new maplibregl.Map({
  container: "map",
  style: {
    version: 8,
    sources: {
      osm: {
        type: "raster",
        tiles: [
          "https://a.tile.openstreetmap.org/{z}/{x}/{y}.png",
          "https://b.tile.openstreetmap.org/{z}/{x}/{y}.png",
          "https://c.tile.openstreetmap.org/{z}/{x}/{y}.png"
        ],
        tileSize: 256,
        attribution: "¬© OpenStreetMap contributors"
      }
    },
    layers: [{ id: "osm", type: "raster", source: "osm" }]
  },
  center: [0, 20],
  zoom: 2
});
map.addControl(new maplibregl.NavigationControl(), "top-right");

/* =============================================================================
   2) MOOD ICONS (0..10)
   ============================================================================= */
function lerp(a,b,t){ return a + (b - a) * t; }
function lerpColor(c1,c2,t){
  const r = Math.round(lerp(c1[0], c2[0], t));
  const g = Math.round(lerp(c1[1], c2[1], t));
  const b = Math.round(lerp(c1[2], c2[2], t));
  return `rgb(${r},${g},${b})`;
}
function moodImageData(level, size=96){
  const t = Math.max(0, Math.min(1, level/10));
  const red=[215,25,28], yellow=[255,255,191], green=[26,150,65];
  const fill = (t < 0.5)
    ? lerpColor(red, yellow, t/0.5)
    : lerpColor(yellow, green, (t-0.5)/0.5);

  const canvas = document.createElement("canvas");
  canvas.width = size; canvas.height = size;
  const ctx = canvas.getContext("2d");

  const cx = size/2, cy = size/2, r = size*0.42;

  ctx.beginPath(); ctx.arc(cx, cy+3, r, 0, Math.PI*2);
  ctx.fillStyle="rgba(0,0,0,0.18)"; ctx.fill();

  ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2);
  ctx.fillStyle = fill; ctx.fill();
  ctx.lineWidth = Math.max(3, size*0.04);
  ctx.strokeStyle = "rgba(0,0,0,0.25)";
  ctx.stroke();

  const eyeY = cy - size*0.10, eyeDX=size*0.14, eyeR=size*0.04;
  ctx.beginPath();
  ctx.arc(cx-eyeDX, eyeY, eyeR, 0, Math.PI*2);
  ctx.arc(cx+eyeDX, eyeY, eyeR, 0, Math.PI*2);
  ctx.fillStyle="rgba(0,0,0,0.75)";
  ctx.fill();

  const browY = eyeY - size*0.08;
  const browTilt = lerp(0.20, -0.20, t);
  ctx.lineWidth = Math.max(3, size*0.035);
  ctx.strokeStyle="rgba(0,0,0,0.55)";
  ctx.lineCap="round";

  ctx.beginPath();
  ctx.moveTo(cx-eyeDX-size*0.06, browY + browTilt*size*0.08);
  ctx.lineTo(cx-eyeDX+size*0.06, browY - browTilt*size*0.08);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(cx+eyeDX-size*0.06, browY - browTilt*size*0.08);
  ctx.lineTo(cx+eyeDX+size*0.06, browY + browTilt*size*0.08);
  ctx.stroke();

  const mouthY = cy + size*0.12, mouthW=size*0.26;
  const curvature = lerp(-1, 1, t);
  ctx.beginPath();
  ctx.moveTo(cx-mouthW, mouthY);
  ctx.quadraticCurveTo(cx, mouthY + curvature*size*0.12, cx+mouthW, mouthY);
  ctx.strokeStyle="rgba(0,0,0,0.70)";
  ctx.lineWidth=Math.max(4, size*0.05);
  ctx.lineCap="round";
  ctx.stroke();

  const img = ctx.getImageData(0,0,size,size);
  return { width: img.width, height: img.height, data: img.data };
}
function ensureMoodImages(){
  for(let lvl=0; lvl<=10; lvl++){
    const name = `mood-${lvl}`;
    if(!map.hasImage(name)) map.addImage(name, moodImageData(lvl,96));
  }
}

/* =============================================================================
   3) POINTS SOURCE + LAYERS
   ============================================================================= */
function initPointsSourceAndLayers(){
  if(map.getSource("points")) return;

  map.addSource("points", {
    type: "geojson",
    data: { type:"FeatureCollection", features: [] },
    cluster: true,
    clusterRadius: 60,
    clusterMaxZoom: 14,
    clusterProperties: {
      sum: ["+", ["get", "value"]],
      count: ["+", 1]
    }
  });

  const avgRoundedClamped = [
    "case",
    ["<", ["round", ["/", ["get","sum"], ["get","count"]]], 0], 0,
    [">", ["round", ["/", ["get","sum"], ["get","count"]]], 10], 10,
    ["round", ["/", ["get","sum"], ["get","count"]]]
  ];

  map.addLayer({
    id: "clusters-mood",
    type: "symbol",
    source: "points",
    filter: ["has", "point_count"],
    layout: {
      "icon-image": ["concat","mood-", ["to-string", avgRoundedClamped]],
      "icon-size": ["step", ["get","point_count"], 0.65, 10, 0.75, 50, 0.9, 200, 1.05, 1000, 1.2],
      "icon-allow-overlap": true,
      "text-field": ["to-string", ["get","point_count"]],
      "text-size": 12,
      "text-offset": [0, 1.55],
      "text-allow-overlap": true,
      "text-anchor": "top"
    },
    paint: {
      "text-color": "rgba(0,0,0,0.75)",
      "text-halo-color": "rgba(255,255,255,0.9)",
      "text-halo-width": 1
    }
  });

  map.addLayer({
    id: "points-mood",
    type: "symbol",
    source: "points",
    filter: ["!", ["has", "point_count"]],
    layout: {
      "icon-image": [
        "concat","mood-",
        ["to-string",
          ["case",
            ["<", ["round", ["get","value"]], 0], 0,
            [">", ["round", ["get","value"]], 10], 10,
            ["round", ["get","value"]]
          ]
        ]
      ],
      "icon-size": 0.55,
      "icon-allow-overlap": true
    }
  });

  map.on("click", "clusters-mood", (e) => {
    const f = e.features[0];
    map.getSource("points").getClusterExpansionZoom(
      f.properties.cluster_id,
      (err, zoom) => {
        if (err) return;
        map.easeTo({ center: f.geometry.coordinates, zoom });
      }
    );
  });

  map.on("mouseenter", "clusters-mood", () => map.getCanvas().style.cursor = "pointer");
  map.on("mouseleave", "clusters-mood", () => map.getCanvas().style.cursor = "");
}

function clearMarkers(){
  const source = map.getSource("points");
  if(!source) return;
  source.setData({ type:"FeatureCollection", features: [] });
}

async function refreshPoints(){
  const source = map.getSource("points");
  if(!source) return;

  const { data, error } = await sb
    .from("mood_entries")
    .select("mood, lon, lat")
    .order("created_at", { ascending:false })
    .limit(20000);

  if(error){
    setAppMessage("Load error:\n" + error.message);
    return;
  }

  const features = (data || [])
    .filter(r => typeof r.lon==="number" && typeof r.lat==="number")
    .map(r => ({
      type: "Feature",
      properties: { value: r.mood },
      geometry: { type:"Point", coordinates:[r.lon, r.lat] }
    }));

  source.setData({ type:"FeatureCollection", features });
  setAppMessage(`Loaded markers: ${features.length}`);
}

/* =============================================================================
   4) UI HELPERS
   ============================================================================= */
const el = id => document.getElementById(id);
const panel = el("panel");

function setAuthMessage(msg){ el("authMsg").textContent = msg || ""; }
function setResetMessage(msg){ el("resetMsg").textContent = msg || ""; }
function setAppMessage(msg){ el("appMsg").textContent = msg || ""; }

const slider = el("slider");
slider.oninput = ()=> el("moodValue").textContent = slider.value;

/* =============================================================================
   5) MUSIC (fade out on login)
   ============================================================================= */
let audioCtx, masterGain, musicStarted = false;
let musicNodes = [];
let chordTimer = null;

function stopLoopTimers() {
  if (chordTimer) { clearTimeout(chordTimer); chordTimer = null; }
}
function fadeOutMusic(seconds = 2.5) {
  if (!audioCtx || !masterGain) return;

  const now = audioCtx.currentTime;
  masterGain.gain.cancelScheduledValues(now);
  masterGain.gain.setValueAtTime(masterGain.gain.value, now);
  masterGain.gain.linearRampToValueAtTime(0.0001, now + seconds);

  setTimeout(() => {
    try { stopLoopTimers(); } catch {}
    for (const n of musicNodes) {
      try { n.stop && n.stop(); } catch {}
      try { n.disconnect && n.disconnect(); } catch {}
    }
    musicNodes = [];
  }, (seconds + 0.3) * 1000);
}
function playAmbientMusic() {
  if (musicStarted) return;
  musicStarted = true;

  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  masterGain = audioCtx.createGain();
  masterGain.gain.value = 0.22;
  masterGain.connect(audioCtx.destination);

  const lp = audioCtx.createBiquadFilter();
  lp.type = "lowpass";
  lp.frequency.value = 1200;
  lp.connect(masterGain);

  const chords = [
    [261.63, 329.63, 392.00],
    [220.00, 261.63, 329.63],
    [174.61, 220.00, 261.63],
    [196.00, 293.66, 392.00]
  ];

  function padChord(freqs, start, dur) {
    for (const f of freqs) {
      const o = audioCtx.createOscillator();
      o.type = "sine";
      o.frequency.value = f;

      const g = audioCtx.createGain();
      g.gain.setValueAtTime(0, start);
      g.gain.linearRampToValueAtTime(0.12, start + 1.2);
      g.gain.linearRampToValueAtTime(0.0, start + dur);

      o.connect(g).connect(lp);
      o.start(start);
      o.stop(start + dur + 0.05);
      musicNodes.push(o, g);
    }
  }

  function arpeggio(freqs, start) {
    const pattern = [0, 1, 2, 1];
    for (let i = 0; i < 8; i++) {
      const f = freqs[pattern[i % pattern.length]] * (i % 2 === 0 ? 2 : 1);
      const o = audioCtx.createOscillator();
      o.type = "triangle";
      o.frequency.value = f;

      const g = audioCtx.createGain();
      const t = start + i * 0.5;
      g.gain.setValueAtTime(0, t);
      g.gain.linearRampToValueAtTime(0.05, t + 0.03);
      g.gain.linearRampToValueAtTime(0, t + 0.45);

      o.connect(g).connect(lp);
      o.start(t);
      o.stop(t + 0.5);
      musicNodes.push(o, g);
    }
  }

  let idx = 0;
  function schedule() {
    const now = audioCtx.currentTime;
    const start = now + 0.02;
    const dur = 7.5;
    const freqs = chords[idx % chords.length];
    padChord(freqs, start, dur);
    arpeggio(freqs, start);
    idx++;
    chordTimer = setTimeout(schedule, dur * 1000);
  }
  schedule();
}

// Auto-start music on first user interaction (browser policy)
function autoStartMusicOnce() {
  playAmbientMusic();
  document.removeEventListener("pointerdown", autoStartMusicOnce);
  document.removeEventListener("keydown", autoStartMusicOnce);
}
document.addEventListener("pointerdown", autoStartMusicOnce, { once: true });
document.addEventListener("keydown", autoStartMusicOnce, { once: true });

/* =============================================================================
   6) SUPABASE CONFIG
   ============================================================================= */
const SUPABASE_URL = "https://ugrmxzdhevqrgftlxfnp.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVncm14emRoZXZxcmdmdGx4Zm5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyODQ3OTQsImV4cCI6MjA4NDg2MDc5NH0.WgTj-6ADFEMrCgPNxeQZvknBBJI1c9uDY9_8Qlkqu4w";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =============================================================================
   7) VIEWS
   ============================================================================= */
function showAuth(){
  panel.className = "panel-welcome";
  el("authView").style.display="block";
  el("appView").style.display="none";
  el("compactView").style.display="none";
  el("resetView").style.display="none";
}
function showReset(){
  panel.className = "panel-welcome";
  el("authView").style.display="none";
  el("appView").style.display="none";
  el("compactView").style.display="none";
  el("resetView").style.display="block";
}
function showApp(){
  panel.className = "panel-app";
  el("authView").style.display="none";
  el("appView").style.display="block";
  el("compactView").style.display="none";
  el("resetView").style.display="none";
}
function showCompact(msg="‚úÖ Saved."){
  panel.className = "panel-compact";
  el("compactMsg").textContent = msg;
  el("authView").style.display="none";
  el("appView").style.display="none";
  el("compactView").style.display="block";
  el("resetView").style.display="none";
}

/* =============================================================================
   8) SIGNUP MODAL
   ============================================================================= */
const overlay = el("overlay");
function openSignupModal(){
  el("suMsg").textContent = "";
  el("suEmail").value = el("email").value.trim();
  el("suPass1").value = "";
  el("suPass2").value = "";
  overlay.style.display = "flex";
  overlay.setAttribute("aria-hidden", "false");
}
function closeSignupModal(){
  overlay.style.display = "none";
  overlay.setAttribute("aria-hidden", "true");
}
overlay.addEventListener("click", (e) => {
  if (e.target === overlay) closeSignupModal();
});
el("btnOpenSignup").onclick = openSignupModal;
el("btnCloseSignup").onclick = closeSignupModal;

/* =============================================================================
   9) URL + PKCE helpers (NO DUPLICATES)
   ============================================================================= */
function getUrlParam(name) {
  return new URLSearchParams(window.location.search).get(name);
}

function urlHasOtpExpiredError(){
  const h = window.location.hash || "";
  return h.includes("otp_expired") || h.includes("error=access_denied");
}

/**
 * We show reset view when:
 * - our UI flag ?reset=1 is present
 * - OR Supabase indicates recovery (type=recovery)
 * - OR PKCE code is present (?code=...)
 * - OR implicit hash token is present (#access_token=...)
 */
function urlHasRecoveryOrReset() {
  const h = window.location.hash || "";
  const s = window.location.search || "";

  if (getUrlParam("reset") === "1") return true;
  if (h.includes("type=recovery") || s.includes("type=recovery")) return true;
  if (getUrlParam("code")) return true;
  if (h.includes("access_token=")) return true;

  return false;
}

/**
 * PKCE: if Supabase returns ?code=..., exchange it for a session
 * BEFORE calling getSession() / updateUser().
 */
async function bootstrapAuthFromUrlIfNeeded() {
  const code = getUrlParam("code");
  if (!code) return;

  const { error } = await sb.auth.exchangeCodeForSession(code);
  if (error) console.warn("exchangeCodeForSession error:", error.message);

  // Clean URL (remove ?code=... but keep path)
  const cleanUrl = window.location.origin + window.location.pathname + window.location.hash;
  window.history.replaceState({}, document.title, cleanUrl);
}

/* =============================================================================
   10) setConnected(user)
   ============================================================================= */
async function setConnected(user){
  if(user){
    showApp();
    fadeOutMusic(2.8);
    clearMarkers();
  }else{
    clearMarkers();
    showAuth();
  }
}

/* =============================================================================
   11) AUTH STATE CHANGE
   ============================================================================= */
sb.auth.onAuthStateChange((event, session) => {
  // Old flow still sometimes emits PASSWORD_RECOVERY
  if (event === "PASSWORD_RECOVERY") {
    showReset();
    setResetMessage("Please choose a new password.");
    clearMarkers();
    return;
  }
  setConnected(session?.user || null);
});

/* =============================================================================
   12) INITIAL BOOTSTRAP
   ============================================================================= */
(async () => {
  await bootstrapAuthFromUrlIfNeeded();

  const { data } = await sb.auth.getSession();

  if (urlHasRecoveryOrReset()) {
    showReset();

    if (urlHasOtpExpiredError()) {
      setResetMessage("This email link is invalid or has expired.\nPlease request a new reset email.");
    } else {
      setResetMessage("Please choose a new password.");
    }

    clearMarkers();
  } else if (urlHasOtpExpiredError()) {
    showAuth();
    setAuthMessage("This email link is invalid or has expired.\nPlease request a new reset email.");
  } else {
    setConnected(data.session?.user || null);
  }
})();

/* =============================================================================
   13) LOGIN
   ============================================================================= */
el("btnLogin").onclick = async () => {
  const email = el("email").value.trim();
  const password = el("password").value;

  if(!email) return setAuthMessage("Error: empty email");
  if(!password) return setAuthMessage("Error: empty password");

  setAuthMessage("Signing in‚Ä¶");

  const { error } = await sb.auth.signInWithPassword({ email, password });

  if(error){
    setAuthMessage("Error:\n" + error.message);
  } else {
    setAuthMessage("");
  }
};

/* =============================================================================
   14) SIGN UP (MODAL)
   ============================================================================= */
let signupBusy = false;
el("btnSignup").onclick = async () => {
  if (signupBusy) return;
  signupBusy = true;

  const btn = el("btnSignup");
  btn.disabled = true;

  const email = el("suEmail").value.trim();
  const p1 = el("suPass1").value;
  const p2 = el("suPass2").value;

  if(!email) { el("suMsg").textContent = "Please enter an email."; btn.disabled=false; signupBusy=false; return; }
  if(!p1 || p1.length < 6) { el("suMsg").textContent = "Password must be at least 6 characters."; btn.disabled=false; signupBusy=false; return; }
  if(p1 !== p2) { el("suMsg").textContent = "Passwords do not match."; btn.disabled=false; signupBusy=false; return; }

  el("suMsg").textContent = "Creating account‚Ä¶";

  const { error } = await sb.auth.signUp({
    email,
    password: p1,
    options: {
      emailRedirectTo: window.location.origin
    }
  });

  if(error){
    el("suMsg").textContent = "Error:\n" + error.message;
    btn.disabled = false;
    signupBusy = false;
    return;
  }

  closeSignupModal();
  showAuth();
  el("email").value = email;
  setAuthMessage("‚úÖ Account created.\nPlease close this window and check your email to confirm your account.");

  btn.disabled = false;
  signupBusy = false;
};

/* =============================================================================
   15) FORGOT PASSWORD
   ‚úÖ Use ?reset=1 (NOT #reset) because the hash may be used by Supabase tokens.
   ============================================================================= */
let forgotBusy = false;
el("btnForgot").onclick = async () => {
  if (forgotBusy) return;
  forgotBusy = true;

  const btn = el("btnForgot");
  btn.disabled = true;

  const email = el("email").value.trim();
  if (!email) {
    setAuthMessage("Please enter your email first.");
    btn.disabled = false;
    forgotBusy = false;
    return;
  }

  setAuthMessage("Sending reset email‚Ä¶");

  const { error } = await sb.auth.resetPasswordForEmail(email, {
    redirectTo: `${window.location.origin}/?reset=1`
  });

  if (error) {
    setAuthMessage("Error:\n" + error.message + "\n\nTip: if you see 'rate limit exceeded', wait a bit and try once.");
  } else {
    setAuthMessage("‚úÖ Reset email sent. Check your inbox (and spam).");
  }

  setTimeout(() => {
    btn.disabled = false;
    forgotBusy = false;
  }, 15000);
};

/* =============================================================================
   16) RESET PASSWORD SCREEN
   ============================================================================= */
el("btnDoReset").onclick = async () => {
  const p1 = el("newPassword1").value;
  const p2 = el("newPassword2").value;

  if(!p1 || p1.length < 6) { setResetMessage("Password must be at least 6 characters."); return; }
  if(p1 !== p2) { setResetMessage("Passwords do not match."); return; }

  setResetMessage("Checking session‚Ä¶");

  await bootstrapAuthFromUrlIfNeeded();
  const { data: sessData } = await sb.auth.getSession();

  if (!sessData?.session) {
    setResetMessage(
      "Auth session missing!\n\n" +
      "Please re-open the reset link from your email (the latest one).\n" +
      "If it still fails, request a new reset email."
    );
    return;
  }

  setResetMessage("Updating password‚Ä¶");

  const { error } = await sb.auth.updateUser({ password: p1 });
  if (error) {
    setResetMessage("Error:\n" + error.message);
    return;
  }

  setResetMessage("‚úÖ Password updated.\nYou can now use the app.");

  // Clean URL
  const cleanUrl = window.location.origin + window.location.pathname;
  history.replaceState(null, "", cleanUrl);
};

el("btnResetCancel").onclick = () => {
  showAuth();
  setResetMessage("");
  const cleanUrl = window.location.origin + window.location.pathname;
  history.replaceState(null, "", cleanUrl);
};

/* =============================================================================
   17) LOGOUT
   ============================================================================= */
async function doLogout(){
  await sb.auth.signOut();
  setAppMessage("");
  showAuth();
}
el("btnLogout").onclick = doLogout;
el("btnLogout2").onclick = doLogout;

/* =============================================================================
   18) ONE BUTTON: Locate + Save + Refresh
   ============================================================================= */
el("btnSaveAll").onclick = async () => {
  setAppMessage("Locating‚Ä¶");

  const { data: { user } } = await sb.auth.getUser();
  if (!user) { setAppMessage("You must be signed in."); return; }

  if (!navigator.geolocation) {
    setAppMessage("Geolocation not supported.");
    return;
  }

  navigator.geolocation.getCurrentPosition(async (pos) => {
    const coords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
    const mood = parseInt(slider.value, 10);

    setAppMessage("Saving‚Ä¶");

    const row = {
      user_id: user.id,
      mood,
      lon: coords.lon,
      lat: coords.lat,
      location: `POINT(${coords.lon} ${coords.lat})`
    };

    const { error } = await sb
      .from("mood_entries")
      .upsert(row, { onConflict: "user_id" });

    if (error) { setAppMessage("Save error:\n" + error.message); return; }

    map.easeTo({ center: [coords.lon, coords.lat], zoom: Math.max(map.getZoom(), 8) });

    setAppMessage("‚úÖ Saved. Loading markers‚Ä¶");
    await refreshPoints();

    showCompact("‚úÖ Saved. Thank you!");
  }, (err) => {
    setAppMessage("Geolocation error: " + err.message);
  }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
};

/* =============================================================================
   19) MAP INIT
   ============================================================================= */
map.on("load", async () => {
  ensureMoodImages();
  initPointsSourceAndLayers();
  clearMarkers();
});
</script>
</body>
</html>
