<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="google-site-verification" content="GwVBCPhOP2ARcKB4mcqgDfqKZ9LX_cp84PxNzmJgWWI" />
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Mood2Know â€” the worldâ€™s emotional weather in one click</title>

<meta name="description" content="Mood2Know â€” the worldâ€™s first emotional weather report. Share your mood in one click and discover the worldâ€™s mood. Anonymous, minimalist, global experiment.">
<meta name="robots" content="index,follow">

<!-- Open Graph (sharing) -->
<meta property="og:title" content="Mood2Know â€” the worldâ€™s mood in one click">
<meta property="og:description" content="The worldâ€™s first emotional weather report. Share your mood anonymously in one click and reveal the collective mood.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://mood2know.com/">
<meta property="og:site_name" content="Mood2Know">
<meta property="og:image" content="https://mood2know.com/og.jpg">
<meta property="og:image:width" content="1201">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="Mood2Know â€” The worldâ€™s emotional weather map">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Mood2Know â€” the worldâ€™s mood in one click">
<meta name="twitter:description" content="The worldâ€™s first emotional weather report. Share your mood anonymously in one click.">
<meta name="twitter:image" content="https://mood2know.com/og.jpg">
<meta name="twitter:image:alt" content="Mood2Know â€” The worldâ€™s emotional weather map">


<link rel="canonical" href="https://mood2know.com/">

<link rel="stylesheet" href="./maplibre-gl.css">

<style>
  html, body { margin:0; height:100%; font:16px system-ui; }
  :root { --vh: 1vh; }

  #map{
    position:fixed; inset:0;
    height: calc(var(--vh) * 100);
  }

  #panel{
    position: fixed;
    z-index: 10;
    background: rgba(255,255,255,0.96);
    border-radius: 16px;
    box-shadow: 0 14px 36px rgba(0,0,0,.25);
    padding: 16px;
    transition: width .25s ease, padding .25s ease, border-radius .25s ease, transform .25s ease;
    padding-bottom: calc(16px + env(safe-area-inset-bottom));
    padding-top: calc(16px + env(safe-area-inset-top));
    left: 12px;
    top: 12px;

    /* âœ… keep panel within viewport + allow internal scroll if content is long */
    max-height: calc(var(--vh) * 100 - 24px);
    overflow-y: auto;
    overscroll-behavior: contain;

    /* âœ… avoid horizontal scrolling when language pills wrap */
    overflow-x: hidden;
  }

  .panel-app{
    width: 340px;
    max-width: calc(100vw - 24px);
  }

  .panel-compact{
    width: 260px;
    max-width: calc(100vw - 24px);
    padding: 10px 12px;
    border-radius: 14px;
  }

  h3 { margin:0; font-size:18px; }

  .titleSub{
    font-size: 18px;
    font-weight: 600;
    line-height: 1.15;
    margin-top: 2px;
    margin-bottom: 10px;
    opacity: 0.75;
  }

/* âœ… hide subtitle in compact panel */
.panel-compact .titleSub {
  display: none;
}


  #dragHandle{
    width: 54px;
    height: 6px;
    border-radius: 999px;
    margin: 6px auto 10px;
    background: rgba(0,0,0,0.18);
    cursor: grab;
    touch-action: none;
  }
  #dragHandle:active{ cursor: grabbing; }

  .row { display:grid; gap:10px; margin:10px 0; }

  input, button, textarea{
    font:inherit;
    padding:12px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.15);
  }
  textarea{ resize: vertical; min-height: 120px; }

  button{ background:#111; color:#fff; border:0; cursor:pointer; }
  button.secondary{ background:#eee; color:#111; }
  button:disabled { opacity:.55; cursor: not-allowed; }

  .small{ font-size:13px; opacity:.75; }
  .msg{ white-space:pre-wrap; font-size:13px; }

  .feelBig{
    font-size: 16px;
    line-height: 1.25;
    font-weight: 650;
    opacity: .95;
  }

  #btnSound{
    width: 100%;
    font-weight: 650;
  }

  #appView, #compactView { display:none; }

  @media (max-width: 520px) {
    .panel-compact{
      width: 150px;
      max-width: 150px;
      padding: 9px 10px;
    }

    button, input, textarea {
      padding: 14px;
      font-size: 16px;
    }

    .feelBig{
      font-size: 17px;
    }
  }

  @media (max-width: 520px) {
    #btnFeedback,
    #btnExpand {
      padding: 10px 8px;
      font-size: 13px;
    }
  }

/* Screen-reader only (SEO + accessibility) */
.sr-only{
  position:absolute;
  width:1px; height:1px;
  padding:0; margin:-1px;
  overflow:hidden;
  clip: rect(0,0,0,0);
  white-space: nowrap;
  border:0;
}


  /* About accordion (minimal + discreet) */
  .m2k-about{ margin-top: 10px; }
  .m2k-details{ border-top: 1px solid rgba(0,0,0,0.08); padding-top: 10px; }

  .m2k-summary{
    cursor:pointer;
    list-style:none;
    display:flex;
    align-items:center;
    gap:8px;
    user-select:none;
    font-size: 12.5px;
    opacity: .72;
  }
  .m2k-summary::-webkit-details-marker{ display:none; }
  .m2k-summary:hover{ opacity: .95; }

  .m2k-summary-icon{ margin-left:auto; opacity: .6; }

  .m2k-lang{
    margin-top: 8px;
    display:flex;
    gap:6px;
    opacity: .75;

    /* âœ… helps EN/FR/ES/IT/DE/ä¸­æ–‡ stay inside panel */
    flex-wrap: wrap;
  }

  /* âœ… fix: show EN/FR text (global button color was white) */
  .m2k-lang-btn{
    color:#111;
    border: 1px solid rgba(0,0,0,.12);
    background: transparent;
    padding: 3px 8px;
    border-radius: 999px;
    font-size: 11.5px;
    cursor: pointer;
  }
  .m2k-lang-btn[aria-pressed="true"]{
    background: rgba(0,0,0,0.06);
    border-color: rgba(0,0,0,.28);
    opacity: 1;
  }

  .m2k-text{
    margin-top: 10px;
    font-size: 13px;
    line-height: 1.55;
    opacity: .88;
  }
  .m2k-text p{ margin: 0 0 10px; }

  /* Feedback modal */
  #fbOverlay{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 60;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 12px;
  }
  #fbModal{
    width: min(720px, 100%);
    background: rgba(255,255,255,0.98);
    border-radius: 16px;
    box-shadow: 0 14px 36px rgba(0,0,0,.25);
    padding: 16px;
  }
  #fbModal h4 { margin: 0 0 10px; font-size: 17px; }
  #fbCount{ font-size: 12px; opacity: .7; text-align:right; margin-top:6px; }
  .modal-actions { display:flex; gap:10px; justify-content:flex-end; }
</style>
</head>

<body>

<h1 class="sr-only">
  Mood2Know â€“ The worldâ€™s emotional weather map
</h1>


<div id="map"></div>

<div id="panel" class="panel-app">
  <h3>Mood2Know</h3>
  <div class="titleSub">the worldâ€™s emotional weather in one click</div>

  <div id="dragHandle" title="Drag panel" aria-label="Drag panel"></div>

  <div id="appView">
    <div class="row">
      <label>Your mood: <b><span id="moodValue">5</span>/10</b></label>
      <input id="slider" type="range" min="0" max="10" value="5">
      <div class="feelBig" id="moodFeeling"></div>
    </div>

    <div class="row">
      <button id="btnSave">Locate + Save</button>
    </div>

    <div class="small" id="hint">
      Pick a mood, then save
    </div>

    <div class="row" id="soundRow" style="margin-top:0; display:none;">
      <button id="btnSound" class="secondary" type="button">ğŸ”Š Enable sound</button>
    </div>

    <div id="appMsg" class="msg"></div>
  </div>

  <div id="compactView">
    <div class="small" id="compactMsg">âœ… Saved.</div>
    <div class="row" style="margin-top:8px; gap:8px;">
      <button id="btnFeedback" class="secondary" type="button">Any comments?</button>
      <button id="btnExpand" class="secondary" type="button">Change mood</button>
    </div>
  </div>

  <!-- ABOUT (accordion, multilingual, SEO-friendly) -->
  <section id="about" class="m2k-about" aria-label="About Mood2Know">
    <details class="m2k-details" id="m2kDetails">
      <summary class="m2k-summary">
        <span class="m2k-summary-label" data-i18n="summary">Why Mood2Know?</span>
        <span class="m2k-summary-icon" aria-hidden="true">â–¾</span>
      </summary>

<div class="m2k-lang" aria-label="Language">
  <button type="button" class="m2k-lang-btn" data-set-lang="en">EN</button>
  <button type="button" class="m2k-lang-btn" data-set-lang="fr">FR</button>
  <button type="button" class="m2k-lang-btn" data-set-lang="es">ES</button>
  <button type="button" class="m2k-lang-btn" data-set-lang="it">IT</button>
  <button type="button" class="m2k-lang-btn" data-set-lang="de">DE</button>
  <button type="button" class="m2k-lang-btn" data-set-lang="zh">ä¸­æ–‡</button>
</div>

      <!-- English -->
      <div class="m2k-text" lang="en" data-lang="en">
        <p><strong>Mood2Know aims to become the worldâ€™s first emotional weather report.</strong></p>
        <p>Every day, millions of people experience emotions that remain invisible. Mood2Know was created to make this collective mood visible, in a simple and anonymous way.</p>
        <p>By answering in just one click, you take part in a global experiment. No account, no explanation, no personal data â€” just a momentary feeling, shared as it is.</p>
        <p>The goal is to reach <strong>10,000 participants</strong>. Once this threshold is reached, Mood2Know will reveal a unique insight: a snapshot of the worldâ€™s emotional state at a given moment.</p>
        <p>This emotional â€œweatherâ€ evolves constantly. Observing its changes helps put individual feelings into perspective and highlights the diversity of human experiences across places and time.</p>
        <p>Mood2Know is not about analysis or diagnosis. It is a minimalist, open space designed for participation, curiosity, and awareness.</p>
        <p><strong>Mood needs you.</strong> Every response matters. The more people take part, the more meaningful this shared emotional picture becomes.</p>
      </div>

      <!-- FranÃ§ais -->
      <div class="m2k-text" lang="fr" data-lang="fr">
        <p><strong>Mood2Know veut devenir la premiÃ¨re mÃ©tÃ©o Ã©motionnelle du monde.</strong></p>
        <p>Chaque jour, des millions de personnes ressentent des Ã©motions qui restent invisibles. Mood2Know est nÃ© pour rendre cette humeur collective visible, simplement et anonymement.</p>
        <p>En rÃ©pondant en un clic, vous participez Ã  une expÃ©rience mondiale. Pas de compte, pas dâ€™explication, pas de donnÃ©es personnelles â€” juste un ressenti du moment, partagÃ© tel quâ€™il est.</p>
        <p>Lâ€™objectif est dâ€™atteindre <strong>10 000 participants</strong>. Une fois ce seuil franchi, Mood2Know pourra rÃ©vÃ©ler une information unique : une photographie de lâ€™Ã©tat Ã©motionnel du monde Ã  un instant donnÃ©.</p>
        <p>Cette â€œmÃ©tÃ©oâ€ Ã©motionnelle Ã©volue en permanence. Observer ses variations aide Ã  prendre du recul sur ce que lâ€™on ressent et montre la diversitÃ© des expÃ©riences humaines, selon les lieux et les pÃ©riodes.</p>
        <p>Mood2Know nâ€™est pas lÃ  pour analyser ou diagnostiquer. Le site se veut minimaliste, ouvert, et pensÃ© pour la participation, la curiositÃ© et la prise de conscience.</p>
        <p><strong>Mood a besoin de vous.</strong> Chaque rÃ©ponse compte. Plus vous Ãªtes nombreux, plus cette image Ã©motionnelle partagÃ©e devient significative.</p>
      </div>

<div class="m2k-text" lang="es" data-lang="es">
  <p><strong>Mood2Know quiere convertirse en el primer clima emocional del mundo.</strong></p>
  <p>Cada dÃ­a, millones de personas sienten emociones que permanecen invisibles. Mood2Know nace para hacer visible ese estado emocional colectivo, de forma simple y anÃ³nima.</p>
  <p>Con un solo clic, participas en una experiencia global. Sin cuenta, sin explicaciÃ³n, sin datos personales â€” solo un sentimiento del momento, compartido tal como es.</p>
  <p>El objetivo es alcanzar <strong>10.000 participantes</strong>. Al llegar a este umbral, Mood2Know revelarÃ¡ una informaciÃ³n Ãºnica: una fotografÃ­a del estado emocional del mundo en un instante concreto.</p>
  <p>Este â€œclimaâ€ emocional cambia constantemente. Observar su evoluciÃ³n ayuda a relativizar lo individual y a mostrar la diversidad de experiencias humanas.</p>
  <p>Mood2Know no analiza ni diagnostica. Es un espacio minimalista, abierto, pensado para la participaciÃ³n y la conciencia colectiva.</p>
  <p><strong>Mood te necesita.</strong> Cada respuesta cuenta.</p>
</div>

<div class="m2k-text" lang="it" data-lang="it">
  <p><strong>Mood2Know vuole diventare la prima meteo emotiva del mondo.</strong></p>
  <p>Ogni giorno, milioni di persone provano emozioni che restano invisibili. Mood2Know nasce per rendere visibile questo stato emotivo collettivo, in modo semplice e anonimo.</p>
  <p>Con un solo clic partecipi a unâ€™esperienza globale. Nessun account, nessuna spiegazione, nessun dato personale â€” solo unâ€™emozione del momento, condivisa cosÃ¬ comâ€™Ã¨.</p>
  <p>Lâ€™obiettivo Ã¨ raggiungere <strong>10.000 partecipanti</strong>. Una volta superata questa soglia, Mood2Know mostrerÃ  unâ€™informazione unica: una fotografia dello stato emotivo del mondo in un dato momento.</p>
  <p>Questa â€œmeteoâ€ emotiva cambia continuamente. Osservarne le variazioni aiuta a mettere in prospettiva ciÃ² che proviamo.</p>
  <p>Mood2Know non analizza nÃ© diagnostica. Ãˆ uno spazio minimale, aperto e partecipativo.</p>
  <p><strong>Mood ha bisogno di te.</strong> Ogni risposta Ã¨ importante.</p>
</div>

<div class="m2k-text" lang="de" data-lang="de">
  <p><strong>Mood2Know mÃ¶chte der erste emotionale Wetterbericht der Welt werden.</strong></p>
  <p>Jeden Tag erleben Millionen von Menschen GefÃ¼hle, die unsichtbar bleiben. Mood2Know wurde geschaffen, um diese kollektive Stimmung sichtbar zu machen â€” einfach und anonym.</p>
  <p>Mit nur einem Klick nimmst du an einem weltweiten Experiment teil. Kein Konto, keine ErklÃ¤rung, keine persÃ¶nlichen Daten â€” nur ein momentanes GefÃ¼hl.</p>
  <p>Das Ziel sind <strong>10.000 Teilnehmende</strong>. Wird diese Schwelle erreicht, zeigt Mood2Know eine einzigartige Momentaufnahme des emotionalen Zustands der Welt.</p>
  <p>Dieses emotionale â€Wetterâ€œ verÃ¤ndert sich stÃ¤ndig. Es zu beobachten hilft, individuelle GefÃ¼hle einzuordnen.</p>
  <p>Mood2Know analysiert oder diagnostiziert nicht. Es ist ein minimalistischer, offener Raum fÃ¼r Bewusstsein und Neugier.</p>
  <p><strong>Mood braucht dich.</strong> Jede Teilnahme zÃ¤hlt.</p>
</div>

<div class="m2k-text" lang="zh" data-lang="zh">
  <p><strong>Mood2Know è‡´åŠ›äºæˆä¸ºä¸–ç•Œä¸Šç¬¬ä¸€ä»½æƒ…ç»ªå¤©æ°”æŠ¥å‘Šã€‚</strong></p>
  <p>æ¯å¤©ï¼Œæ•°ç™¾ä¸‡äººä½“éªŒç€éš¾ä»¥è¢«çœ‹è§çš„æƒ…ç»ªã€‚Mood2Know çš„è¯ç”Ÿï¼Œæ˜¯ä¸ºäº†ä»¥ç®€å•ã€åŒ¿åçš„æ–¹å¼å‘ˆç°è¿™ç§é›†ä½“æƒ…ç»ªã€‚</p>
  <p>åªéœ€ä¸€æ¬¡ç‚¹å‡»ï¼Œä½ å°±èƒ½å‚ä¸ä¸€é¡¹å…¨çƒæ€§çš„å®éªŒã€‚æ— éœ€è´¦å·ã€æ— éœ€è§£é‡Šã€æ— éœ€ä¸ªäººä¿¡æ¯ â€”â€” åªæ˜¯å½“ä¸‹çš„çœŸå®æ„Ÿå—ã€‚</p>
  <p>ç›®æ ‡æ˜¯è¾¾åˆ° <strong>10,000 åå‚ä¸è€…</strong>ã€‚ä¸€æ—¦è¾¾æˆï¼ŒMood2Know å°†å±•ç¤ºä¸€ä¸ªç‹¬ç‰¹çš„è§†è§’ï¼šæŸä¸€æ—¶åˆ»ä¸–ç•Œçš„æƒ…ç»ªå¿«ç…§ã€‚</p>
  <p>è¿™ç§â€œæƒ…ç»ªå¤©æ°”â€ä¸æ–­å˜åŒ–ã€‚è§‚å¯Ÿå®ƒï¼Œæœ‰åŠ©äºç†è§£ä¸ªä½“æƒ…ç»ªä¸ä¸–ç•Œä¹‹é—´çš„è”ç³»ã€‚</p>
  <p>Mood2Know ä¸è¿›è¡Œåˆ†ææˆ–è¯Šæ–­ï¼Œè€Œæ˜¯ä¸€ä¸ªæç®€ã€å¼€æ”¾ã€é¼“åŠ±å‚ä¸çš„ç©ºé—´ã€‚</p>
  <p><strong>Mood éœ€è¦ä½ ã€‚</strong> æ¯ä¸€æ¬¡å‚ä¸éƒ½å¾ˆé‡è¦ã€‚</p>
</div>

<p class="small" style="margin-top:12px;">
  Learn more:
  <a href="/emotional-weather-map.html">Emotional weather map of the world</a>
</p>


    </details>
  </section>
</div>

<!-- FEEDBACK MODAL -->
<div id="fbOverlay" aria-hidden="true">
  <div id="fbModal" role="dialog" aria-modal="true">
    <h4>Send a comment</h4>
    <div class="small">This message will be stored automatically.</div>
    <div style="height:10px"></div>

    <label class="small" for="fbText">Message</label>
    <textarea id="fbText" maxlength="5000" placeholder="Write your comment here (max 5000 characters)â€¦"></textarea>
    <div id="fbCount">0 / 5000 â€¢ 0 / 250 words</div>

    <div id="fbMsg" class="msg" style="margin-top:8px;"></div>

    <div class="modal-actions" style="margin-top:12px;">
      <button id="btnFbCancel" class="secondary" type="button">Cancel</button>
      <button id="btnFbSend" type="button">Send</button>
    </div>
  </div>
</div>

<script src="./maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* =============================================================================
   0) MOBILE VIEWPORT FIX (iOS)
   ============================================================================= */
function setVh() {
  document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
}
window.addEventListener('resize', setVh);
setVh();

/* =============================================================================
   1) MAP SETUP
   ============================================================================= */
const map = new maplibregl.Map({
  container: "map",
  style: {
    version: 8,
    sources: {
      osm: {
        type: "raster",
        tiles: [
          "https://a.tile.openstreetmap.org/{z}/{x}/{y}.png",
          "https://b.tile.openstreetmap.org/{z}/{x}/{y}.png",
          "https://c.tile.openstreetmap.org/{z}/{x}/{y}.png"
        ],
        tileSize: 256,
        attribution: "Â© OpenStreetMap contributors"
      }
    },
    layers: [{ id: "osm", type: "raster", source: "osm" }]
  },
  center: [0, 20],
  zoom: 2
});
map.addControl(new maplibregl.NavigationControl(), "top-right");

/* =============================================================================
   2) MOOD ICONS (0..10)
   ============================================================================= */
function lerp(a,b,t){ return a + (b - a) * t; }
function lerpColor(c1,c2,t){
  const r = Math.round(lerp(c1[0], c2[0], t));
  const g = Math.round(lerp(c1[1], c2[1], t));
  const b = Math.round(lerp(c1[2], c2[2], t));
  return `rgb(${r},${g},${b})`;
}
function moodImageData(level, size=96){
  const t = Math.max(0, Math.min(1, level/10));
  const red=[215,25,28], yellow=[255,255,191], green=[26,150,65];
  const fill = (t < 0.5)
    ? lerpColor(red, yellow, t/0.5)
    : lerpColor(yellow, green, (t-0.5)/0.5);

  const canvas = document.createElement("canvas");
  canvas.width = size; canvas.height = size;
  const ctx = canvas.getContext("2d");

  const cx = size/2, cy = size/2, r = size*0.42;

  ctx.beginPath(); ctx.arc(cx, cy+3, r, 0, Math.PI*2);
  ctx.fillStyle="rgba(0,0,0,0.18)"; ctx.fill();

  ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2);
  ctx.fillStyle = fill; ctx.fill();
  ctx.lineWidth = Math.max(3, size*0.04);
  ctx.strokeStyle = "rgba(0,0,0,0.25)";
  ctx.stroke();

  const eyeY = cy - size*0.10, eyeDX=size*0.14, eyeR=size*0.04;
  ctx.beginPath();
  ctx.arc(cx-eyeDX, eyeY, eyeR, 0, Math.PI*2);
  ctx.arc(cx+eyeDX, eyeY, eyeR, 0, Math.PI*2);
  ctx.fillStyle="rgba(0,0,0,0.75)";
  ctx.fill();

  const browY = eyeY - size*0.08;
  const browTilt = lerp(0.20, -0.20, t);
  ctx.lineWidth = Math.max(3, size*0.035);
  ctx.strokeStyle="rgba(0,0,0,0.55)";
  ctx.lineCap="round";

  ctx.beginPath();
  ctx.moveTo(cx-eyeDX-size*0.06, browY + browTilt*size*0.08);
  ctx.lineTo(cx-eyeDX+size*0.06, browY - browTilt*size*0.08);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(cx+eyeDX-size*0.06, browY - browTilt*size*0.08);
  ctx.lineTo(cx+eyeDX+size*0.06, browY + browTilt*size*0.08);
  ctx.stroke();

  const mouthY = cy + size*0.12, mouthW=size*0.26;
  const curvature = lerp(-1, 1, t);
  ctx.beginPath();
  ctx.moveTo(cx-mouthW, mouthY);
  ctx.quadraticCurveTo(cx, mouthY + curvature*size*0.12, cx+mouthW, mouthY);
  ctx.strokeStyle="rgba(0,0,0,0.70)";
  ctx.lineWidth=Math.max(4, size*0.05);
  ctx.lineCap="round";
  ctx.stroke();

  const img = ctx.getImageData(0,0,size,size);
  return { width: img.width, height: img.height, data: img.data };
}
function ensureMoodImages(){
  for(let lvl=0; lvl<=10; lvl++){
    const name = `mood-${lvl}`;
    if(!map.hasImage(name)) map.addImage(name, moodImageData(lvl,96));
  }
}

/* =============================================================================
   3) POINTS SOURCE + LAYERS
   ============================================================================= */
function initPointsSourceAndLayers(){
  if(map.getSource("points")) return;

  map.addSource("points", {
    type: "geojson",
    data: { type:"FeatureCollection", features: [] },
    cluster: true,
    clusterRadius: 60,
    clusterMaxZoom: 14,
    clusterProperties: { sum: ["+", ["get", "value"]], count: ["+", 1] }
  });

  const avgRoundedClamped = [
    "case",
    ["<", ["round", ["/", ["get","sum"], ["get","count"]]], 0], 0,
    [">", ["round", ["/", ["get","sum"], ["get","count"]]], 10], 10,
    ["round", ["/", ["get","sum"], ["get","count"]]]
  ];

  map.addLayer({
    id: "clusters-mood",
    type: "symbol",
    source: "points",
    filter: ["has", "point_count"],
    layout: {
      "icon-image": ["concat","mood-", ["to-string", avgRoundedClamped]],
      "icon-size": ["step", ["get","point_count"], 0.65, 10, 0.75, 50, 0.9, 200, 1.05, 1000, 1.2],
      "icon-allow-overlap": true,
      "text-field": ["to-string", ["get","point_count"]],
      "text-size": 12,
      "text-offset": [0, 1.55],
      "text-allow-overlap": true,
      "text-anchor": "top"
    },
    paint: {
      "text-color": "rgba(0,0,0,0.75)",
      "text-halo-color": "rgba(255,255,255,0.9)",
      "text-halo-width": 1
    }
  });

  map.addLayer({
    id: "points-mood",
    type: "symbol",
    source: "points",
    filter: ["!", ["has", "point_count"]],
    layout: {
      "icon-image": [
        "concat","mood-",
        ["to-string",
          ["case",
            ["<", ["round", ["get","value"]], 0], 0,
            [">", ["round", ["get","value"]], 10], 10,
            ["round", ["get","value"]]
          ]
        ]
      ],
      "icon-size": 0.55,
      "icon-allow-overlap": true
    }
  });

  map.on("click", "clusters-mood", (e) => {
    const f = e.features[0];
    map.getSource("points").getClusterExpansionZoom(
      f.properties.cluster_id,
      (err, zoom) => {
        if (err) return;
        map.easeTo({ center: f.geometry.coordinates, zoom });
      }
    );
  });

  map.on("mouseenter", "clusters-mood", () => map.getCanvas().style.cursor = "pointer");
  map.on("mouseleave", "clusters-mood", () => map.getCanvas().style.cursor = "");
}

function clearMarkers(){
  const source = map.getSource("points");
  if(!source) return;
  source.setData({ type:"FeatureCollection", features: [] });
}

let revealedThisSession = false;

async function refreshPoints(){
  if (!revealedThisSession) return;

  const source = map.getSource("points");
  if(!source) return;

  const { data, error } = await sb
    .from("mood_entries")
    .select("mood, lon, lat")
    .order("created_at", { ascending:false })
    .limit(20000);

  if(error){
    setAppMessage("Load failed: " + (error.message || "Unknown error"));
    console.warn("LOAD error:", error);
    return;
  }

  const features = (data || [])
    .filter(r => typeof r.lon==="number" && typeof r.lat==="number")
    .map(r => ({
      type: "Feature",
      properties: { value: r.mood },
      geometry: { type:"Point", coordinates:[r.lon, r.lat] }
    }));

  source.setData({ type:"FeatureCollection", features });
}

/* =============================================================================
   4) UI HELPERS + VIEWS
   ============================================================================= */
const el = id => document.getElementById(id);
const panel = el("panel");

const isPhone = window.matchMedia("(pointer: coarse)").matches || window.matchMedia("(max-width: 520px)").matches;

function collapseAbout() {
  const d = el("m2kDetails");
  if (d) d.open = false;
}

function showApp(){
  panel.className = "panel-app";
  el("appView").style.display = "block";
  el("compactView").style.display = "none";
}
function showCompact(msg="âœ… Saved."){
  panel.className = "panel-compact";
  el("compactMsg").textContent = msg;
  el("appView").style.display = "none";
  el("compactView").style.display = "block";
}
function setAppMessage(msg){ el("appMsg").textContent = msg || ""; }

const slider = el("slider");
const moodFeeling = el("moodFeeling");

/* mood value used by music */
let currentMood = Number(slider.value);

function moodLabel(v){
  v = Number(v);
  if (v <= 2) return "low";
  if (v <= 4) return "meh";
  if (v <= 6) return "okay";
  if (v <= 8) return "good";
  return "great";
}
function updateFeeling(){
  const v = Number(slider.value);
  moodFeeling.textContent = `You're feeling ${moodLabel(v)}.`;
}
slider.oninput = ()=> {
  el("moodValue").textContent = slider.value;
  currentMood = Number(slider.value);
  updateFeeling();
  updateMusicParams(); // live update if music started
};

// âœ… iOS Safari fix: ensure slider value sync on first touch
slider.addEventListener("touchstart", () => {
  el("moodValue").textContent = slider.value;
  currentMood = Number(slider.value);
  updateFeeling();
}, { passive: true });


/* =============================================================================
   4.5) DRAGGABLE PANEL VIA HANDLE
   ============================================================================= */
const dragHandle = el("dragHandle");
let dragging = false;
let dragOffX = 0, dragOffY = 0;

dragHandle.addEventListener("pointerdown", (e) => {
  dragging = true;
  panel.setPointerCapture(e.pointerId);

  const rect = panel.getBoundingClientRect();
  dragOffX = e.clientX - rect.left;
  dragOffY = e.clientY - rect.top;
});

panel.addEventListener("pointermove", (e) => {
  if (!dragging) return;

  let x = e.clientX - dragOffX;
  let y = e.clientY - dragOffY;

  const maxX = window.innerWidth - panel.offsetWidth - 8;
  const maxY = window.innerHeight - panel.offsetHeight - 8;
  x = Math.max(8, Math.min(maxX, x));
  y = Math.max(8, Math.min(maxY, y));

  panel.style.left = x + "px";
  panel.style.top  = y + "px";
  panel.style.right = "auto";
  panel.style.bottom = "auto";
});

panel.addEventListener("pointerup", () => { dragging = false; });
panel.addEventListener("pointercancel", () => { dragging = false; });

/* =============================================================================
   5) AMBIENT MUSIC (mood-adaptive + transposition) âœ… + hide/restart
   ============================================================================= */
let audioCtx, masterGain, musicStarted = false;
let musicNodes = [];
let chordTimer = null;
let musicFilter = null;

function stopLoopTimers() {
  if (chordTimer) { clearTimeout(chordTimer); chordTimer = null; }
}

function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

/* pitch shift (semitones) based on mood */
function getTransposeSemitones(){
  const t = clamp(currentMood / 10, 0, 1);
  return Math.round(lerp(-4, 4, t));
}
function pitchShiftFactor(){
  const st = getTransposeSemitones();
  return Math.pow(2, st / 12);
}

function fadeOutMusic(seconds = 2.6) {
  if (!audioCtx || !masterGain) return;

  const now = audioCtx.currentTime;
  masterGain.gain.cancelScheduledValues(now);
  masterGain.gain.setValueAtTime(masterGain.gain.value, now);
  masterGain.gain.linearRampToValueAtTime(0.0001, now + seconds);

  setTimeout(() => {
    try { stopLoopTimers(); } catch {}
    for (const n of musicNodes) {
      try { n.stop && n.stop(); } catch {}
      try { n.disconnect && n.disconnect(); } catch {}
    }
    musicNodes = [];
    musicStarted = false;
  }, (seconds + 0.3) * 1000);
}

function updateMusicParams() {
  if (!audioCtx || !masterGain || !musicFilter) return;

  const t = clamp(currentMood / 10, 0, 1);
  const targetVol = lerp(0.16, 0.24, t);
  const targetCutoff = lerp(700, 2200, t);

  const now = audioCtx.currentTime;

  masterGain.gain.cancelScheduledValues(now);
  masterGain.gain.setTargetAtTime(targetVol, now, 0.12);

  musicFilter.frequency.cancelScheduledValues(now);
  musicFilter.frequency.setTargetAtTime(targetCutoff, now, 0.12);
}

function getChordPalette() {
  const low = [
    [220.00, 261.63, 329.63],
    [174.61, 220.00, 261.63],
    [146.83, 174.61, 220.00],
    [164.81, 246.94, 329.63]
  ];

  const mid = [
    [261.63, 329.63, 392.00],
    [220.00, 261.63, 329.63],
    [174.61, 220.00, 261.63],
    [196.00, 293.66, 392.00]
  ];

  const high = [
    [261.63, 392.00, 523.25],
    [196.00, 293.66, 392.00],
    [220.00, 329.63, 440.00],
    [174.61, 261.63, 349.23]
  ];

  if (currentMood <= 3) return low;
  if (currentMood <= 7) return mid;
  return high;
}

function playAmbientMusic() {
  if (musicStarted) return;
  musicStarted = true;

  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  try { audioCtx.resume && audioCtx.resume(); } catch(e){}

  masterGain = audioCtx.createGain();
  masterGain.gain.value = 0.20;
  masterGain.connect(audioCtx.destination);

  musicFilter = audioCtx.createBiquadFilter();
  musicFilter.type = "lowpass";
  musicFilter.frequency.value = 1200;
  musicFilter.connect(masterGain);

  updateMusicParams();

  function padChord(freqs, start, dur, moodT) {
    const padPeak = lerp(0.085, 0.13, moodT);
    const factor = pitchShiftFactor();

    for (const f0 of freqs) {
      const f = f0 * factor;

      const o = audioCtx.createOscillator();
      o.type = (moodT < 0.35) ? "sine" : "triangle";
      o.frequency.value = f;

      const g = audioCtx.createGain();
      g.gain.setValueAtTime(0, start);
      g.gain.linearRampToValueAtTime(padPeak, start + 1.1);
      g.gain.linearRampToValueAtTime(0.0, start + dur);

      o.connect(g).connect(musicFilter);
      o.start(start);
      o.stop(start + dur + 0.05);
      musicNodes.push(o, g);
    }
  }

  function arpeggio(freqs, start, moodT) {
    const step = lerp(0.62, 0.34, moodT);
    const notes = 8;
    const pattern = [0, 1, 2, 1];
    const factor = pitchShiftFactor();

    for (let i = 0; i < notes; i++) {
      const base = freqs[pattern[i % pattern.length]] * (i % 2 === 0 ? 2 : 1);
      const f = base * factor;

      const o = audioCtx.createOscillator();
      o.type = "triangle";
      o.frequency.value = f;

      const g = audioCtx.createGain();
      const t = start + i * step;
      const peak = lerp(0.035, 0.06, moodT);

      g.gain.setValueAtTime(0, t);
      g.gain.linearRampToValueAtTime(peak, t + 0.03);
      g.gain.linearRampToValueAtTime(0, t + step - 0.05);

      o.connect(g).connect(musicFilter);
      o.start(t);
      o.stop(t + step);
      musicNodes.push(o, g);
    }
  }

  let idx = 0;
  function schedule() {
    const now = audioCtx.currentTime;
    const moodT = clamp(currentMood / 10, 0, 1);
    const dur = lerp(9.0, 6.2, moodT);

    const chords = getChordPalette();
    const freqs = chords[idx % chords.length];
    const start = now + 0.02;

    padChord(freqs, start, dur, moodT);
    arpeggio(freqs, start, moodT);

    idx++;
    chordTimer = setTimeout(schedule, dur * 1000);
  }
  schedule();
}

function iosUnlockHack(ctx){
  try{
    const buffer = ctx.createBuffer(1, 1, 22050);
    const src = ctx.createBufferSource();
    src.buffer = buffer;
    src.connect(ctx.destination);
    src.start(0);
    src.stop(0);
  }catch(e){}
}

function isAudioRunning(){
  return !!(audioCtx && audioCtx.state === "running" && musicStarted);
}

function showSoundButton(show){
  const row = el("soundRow");
  if (!row) return;
  row.style.display = show ? "block" : "none";
}

function unlockAndStartAudio(){
  try {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      iosUnlockHack(audioCtx);
    }
    try { audioCtx.resume && audioCtx.resume(); } catch(e){}

    if (!musicStarted) playAmbientMusic();
    try { audioCtx.resume && audioCtx.resume(); } catch(e){}

    if (audioCtx && audioCtx.state === "running") showSoundButton(false);
    updateMusicParams();
  } catch(e) {}
}

function restartMusicIfPossible(){
  if (audioCtx && audioCtx.state === "running") {
    if (!musicStarted) playAmbientMusic();
    showSoundButton(false);
    updateMusicParams();
    return;
  }
  if (isPhone) showSoundButton(true);
}

(function attachAudioUnlockOnce(){
  const opts = { capture: true, passive: true, once: true };
  document.addEventListener("touchstart", unlockAndStartAudio, opts);
  document.addEventListener("pointerdown", unlockAndStartAudio, opts);
  document.addEventListener("mousedown", unlockAndStartAudio, opts);
  document.addEventListener("keydown", unlockAndStartAudio, { capture:true, once:true });

  slider.addEventListener("touchstart", unlockAndStartAudio, { passive:true });
  slider.addEventListener("pointerdown", unlockAndStartAudio, { passive:true });
  el("btnSave").addEventListener("touchstart", unlockAndStartAudio, { passive:true });
  el("btnSave").addEventListener("pointerdown", unlockAndStartAudio, { passive:true });
})();

el("btnSound").addEventListener("click", () => {
  showSoundButton(false);
  unlockAndStartAudio();
  setTimeout(() => {
    if (!isAudioRunning()) showSoundButton(true);
  }, 800);
});

function soundWatchdog(){
  const likelyPhone = isPhone || window.matchMedia("(pointer: coarse)").matches;
  if (!likelyPhone) return;

  setTimeout(() => { if (!isAudioRunning()) showSoundButton(true); }, 900);
  setTimeout(() => { if (!isAudioRunning()) showSoundButton(true); }, 2500);
}

/* =============================================================================
   6) SUPABASE CONFIG
   ============================================================================= */
const SUPABASE_URL = "https://ugrmxzdhevqrgftlxfnp.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVncm14emRoZXZxcmdmdGx4Zm5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyODQ3OTQsImV4cCI6MjA4NDg2MDc5NH0.WgTj-6ADFEMrCgPNxeQZvknBBJI1c9uDY9_8Qlkqu4w";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

function getAnonId(){
  const key = "mood_anon_id";
  let v = localStorage.getItem(key);
  if(!v){
    v = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "-" + Math.random());
    localStorage.setItem(key, v);
  }
  return v;
}

/* =============================================================================
   7) SAVE (Locate + Save)
   ============================================================================= */
el("btnSave").onclick = async () => {
  setAppMessage("Locatingâ€¦");
  el("btnSave").disabled = true;

  if (!navigator.geolocation) {
    setAppMessage("Geolocation is not supported on this device.");
    el("btnSave").disabled = false;
    return;
  }

  navigator.geolocation.getCurrentPosition(async (pos) => {
    const coords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
    const mood = parseInt(slider.value, 10);
    const anonId = getAnonId();

    setAppMessage("Saving your moodâ€¦");

    const row = { anon_id: anonId, mood, lon: coords.lon, lat: coords.lat };

    const { error } = await sb
      .from("mood_entries")
      .upsert(row, { onConflict: "anon_id" });

    if (error) {
      setAppMessage("Save failed: " + (error.message || "Unknown error"));
      console.warn("SAVE error:", error);
      el("btnSave").disabled = false;
      return;
    }

    fadeOutMusic(2.6);
    revealedThisSession = true;

    collapseAbout();

    setAppMessage("Thank you! Loading the worldâ€™s moodâ€¦");
    map.easeTo({ center: [coords.lon, coords.lat], zoom: Math.max(map.getZoom(), 8) });

    setTimeout(async () => {
      await refreshPoints();
      showCompact("âœ… Saved. Thank you!");
      el("btnSave").disabled = false;
    }, 700);

  }, (err) => {
    setAppMessage("Geolocation error: " + err.message);
    el("btnSave").disabled = false;
  }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
};

el("btnExpand").onclick = () => {
  showApp();
  setAppMessage("");
  restartMusicIfPossible();
};

/* =============================================================================
   8) FEEDBACK MODAL â€” "Any comments?" works
   ============================================================================= */
const FEEDBACK_MAX_WORDS = 250;
function countWords(s){ return (s.trim().match(/\S+/g) || []).length; }

const fbOverlay = el("fbOverlay");
const fbText = el("fbText");
const fbMsg  = el("fbMsg");
const fbCount = el("fbCount");
const btnFbSend = el("btnFbSend");

function updateFbCounter(){
  const chars = fbText.value.length;
  const words = countWords(fbText.value);
  fbCount.textContent = `${chars} / 5000 â€¢ ${words} / ${FEEDBACK_MAX_WORDS} words`;
}

function openFeedbackModal(){
  fbMsg.textContent = "";
  fbText.value = "";
  fbOverlay.style.display = "flex";
  fbOverlay.setAttribute("aria-hidden", "false");
  updateFbCounter();
  setTimeout(() => fbText.focus(), 50);
}
function closeFeedbackModal(){
  fbOverlay.style.display = "none";
  fbOverlay.setAttribute("aria-hidden", "true");
}

fbOverlay.addEventListener("click", (e) => { if (e.target === fbOverlay) closeFeedbackModal(); });
el("btnFbCancel").onclick = closeFeedbackModal;
fbText.addEventListener("input", updateFbCounter);

el("btnFeedback").onclick = () => openFeedbackModal();

btnFbSend.onclick = async () => {
  btnFbSend.disabled = true;
  fbMsg.textContent = "Sendingâ€¦";

  const message = fbText.value.trim();
  if (message.length < 2) {
    fbMsg.textContent = "Please write a message.";
    btnFbSend.disabled = false;
    return;
  }
  const words = countWords(message);
  if (words > FEEDBACK_MAX_WORDS) {
    fbMsg.textContent = `Too many words (${words}). Max is ${FEEDBACK_MAX_WORDS}.`;
    btnFbSend.disabled = false;
    return;
  }

  const { error } = await sb.from("mood_feedback").insert({
    anon_id: getAnonId(),
    message
  });

  if (error) {
    const raw = (error.message || "") + " " + (error.details || "") + " " + (error.hint || "");
    const isDuplicate =
      error.code === "23505" ||
      raw.includes("duplicate key value") ||
      raw.toLowerCase().includes("one_per_day");

    fbMsg.textContent = isDuplicate
      ? "Only one comment per day please!"
      : "Unable to send comment. Please try again.";

    console.warn("FEEDBACK error:", error);
    btnFbSend.disabled = false;
    return;
  }

  fbMsg.textContent = "âœ… Thank you for your feedback!";
  setTimeout(() => closeFeedbackModal(), 700);
  btnFbSend.disabled = false;
};

/* =============================================================================
   9) INIT
   ============================================================================= */
map.on("load", async () => {
  ensureMoodImages();
  initPointsSourceAndLayers();
  clearMarkers();
  revealedThisSession = false;

  showApp();

// âœ… iOS fix: force range repaint + sync displayed value
requestAnimationFrame(() => {
  slider.value = slider.value; // triggers a repaint in iOS Safari
  el("moodValue").textContent = slider.value;
  currentMood = Number(slider.value);
  updateFeeling();
  updateMusicParams();
});



  soundWatchdog();
});
</script>

<!-- âœ… Language switcher script (EN default) -->
<script>
(function () {
  const blocks = Array.from(document.querySelectorAll('.m2k-text[data-lang]'));
  const summaryLabel = document.querySelector('[data-i18n="summary"]');
  const buttons = Array.from(document.querySelectorAll('.m2k-lang-btn[data-set-lang]'));

  function pickDefaultLang() {
    const saved = localStorage.getItem('m2k_lang');
    return saved || 'en';
  }

  function setLang(lang) {
    blocks.forEach(el => el.style.display = (el.dataset.lang === lang ? 'block' : 'none'));

    if (summaryLabel) {
      const titles = {
        en: 'Why Mood2Know?',
        fr: 'Pourquoi Mood2Know ?',
        es: 'Â¿Por quÃ© Mood2Know?',
        it: 'PerchÃ© Mood2Know?',
        de: 'Warum Mood2Know?',
        zh: 'ä¸ºä»€ä¹ˆé€‰æ‹© Mood2Knowï¼Ÿ'
      };
      summaryLabel.textContent = titles[lang] || titles.en;
    }

    buttons.forEach(btn => {
      const on = btn.dataset.setLang === lang;
      btn.setAttribute('aria-pressed', on ? 'true' : 'false');
    });

    localStorage.setItem('m2k_lang', lang);
  }

  buttons.forEach(btn => btn.addEventListener('click', () => setLang(btn.dataset.setLang)));
  setLang(pickDefaultLang());
})();
</script>

<script>
(function () {
  if (location.hash === '#about') {
    const details = document.getElementById('m2kDetails');
    if (details) {
      details.open = true;
      details.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }
})();
</script>


</body>
</html>
